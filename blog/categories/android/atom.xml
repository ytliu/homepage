<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Android | Mctrain's Blog]]></title>
  <link href="http://ytliu.github.com/blog/categories/android/atom.xml" rel="self"/>
  <link href="http://ytliu.github.com/"/>
  <updated>2013-04-02T11:34:03+08:00</updated>
  <id>http://ytliu.github.com/</id>
  <author>
    <name><![CDATA[Liu Yutao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Cross Reference Graph of Android Component]]></title>
    <link href="http://ytliu.github.com/blog/2013/03/24/cross-reference-graph-of-android-component/"/>
    <updated>2013-03-24T13:35:00+08:00</updated>
    <id>http://ytliu.github.com/blog/2013/03/24/cross-reference-graph-of-android-component</id>
    <content type="html"><![CDATA[<p>由于项目的需要，这周写了一个ruby project——<a href="https://github.com/ytliu/apk-static-xref">apk-static-xref</a>。</p>

<p>虽然现在Android静态分析的项目很多，但是我都没有找到一个看上去很简单的功能：给定一个component，找出它所有调用到的函数，然后画出call graph。</p>

<p>现在的大部分call graph都只能限制在一个class文件里，这里所说的cross reference graph (XRG)就是指函数调用是跨class文件的，需要cross reference直到调用的是Android本身的API或者Java API。</p>

<p>这其实是一个很简单的功能，但我不知道为什么一直找不到工具可以满足我的需求，直到找到了spark的一个<a href="http://appsrv.cse.cuhk.edu.hk/~mzheng/DroidTrace.pdf">slide</a>，里面提到一个cross reference graph。其实就是一个对smali文件的DFS算法。</p>

<p>于是我把<a href="">smali-cfg</a>和<a href="">redexer</a>结合了一下，写了这个ruby project，具体做法就是：</p>

<ul>
<li><p>用apktool unpack apk：</p>

<p>  $ java -jar apktool.jar -d source.apk target.dir</p></li>
<li><p>用nokogiri parse AndroidManefest.xml 找出所有的service和activity：</p>

<p>  Nokogiri::XML(f)</p></li>
<li><p>用DFS遍历所有的smali文件，得出整个call graph的结点和边：</p></li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_assign</span><span class="p">(</span><span class="n">apk</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">pty</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">ori_cls</span><span class="p">)</span>
</span><span class='line'>  <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="nb">caller</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">callee</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">vclass</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">filename</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="n">smali</span> <span class="o">+</span> <span class="n">cls</span> <span class="o">+</span> <span class="s2">&quot;.smali&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;fh = File.open(filename, &quot;r&quot;)</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  else&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">return</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span><span class='line'>  <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="n">lines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;line = line[0...-1]</span>
</span><span class='line'><span class="sr">if line.start_with?(&quot;.class&quot;)</span>
</span><span class='line'><span class="sr">  vclass = line.split(&#39; &#39;)[-1][1...-1]</span>
</span><span class='line'><span class="sr">elsif line.start_with?(&quot;.method&quot;)</span>
</span><span class='line'><span class="sr">  caller = Invoker.new(vclass, line)</span>
</span><span class='line'><span class="sr">  if (caller.mtd.eql?(mtd)) and (caller.pty.eql?(pty))</span>
</span><span class='line'><span class="sr">    match = 1</span>
</span><span class='line'><span class="sr">  end</span>
</span><span class='line'><span class="sr">elsif line.start_with?(&quot;.end method&quot;)</span>
</span><span class='line'><span class="sr">  match = 0</span>
</span><span class='line'><span class="sr">elsif line.include?(&quot;invoke-&quot;)</span>
</span><span class='line'><span class="sr">  callee = Invoked.new(line)</span>
</span><span class='line'><span class="sr">  if (match == 1) or (flag == 1)</span>
</span><span class='line'><span class="sr">    if $caller_methods.include?(callee.str)</span>
</span><span class='line'><span class="sr">      if !$caller_methods.include?(caller.str)</span>
</span><span class='line'><span class="sr">        addNodes(caller.str, callee.str) if $graph_need</span>
</span><span class='line'><span class="sr">      end</span>
</span><span class='line'><span class="sr">    else</span>
</span><span class='line'><span class="sr">      addNodes(caller.str, callee.str) if $graph_need</span>
</span><span class='line'><span class="sr">      $caller_methods &amp;lt;&amp;lt; caller.str</span>
</span><span class='line'><span class="sr">      run_assign(apk, callee.cls, callee.mtd, callee.pty, 0, ori_cls)</span>
</span><span class='line'><span class="sr">    end</span>
</span><span class='line'><span class="sr">  end</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  }</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li><p>用ruby-graphviz画出call graph</p>

<p>  $graph.output(:png => "#{to}.png")</p></li>
</ul>


<p>其实整个过程非常的简单，不过可能自己代码写得比较烂，会不太好理解。另外，现在是先用apktool把apk翻译成smali之后再对smali进行操作，效率可能会比较慢，接下来准备把实现改成直接对dex文件进行分析，打算基于Android自带的dexdump或者开源的baksmali，顺便把dex的格式搞得更加清楚一点。</p>

<hr />

<p>由于下周一门课的原因，这周又把OSDI 2012的<a href="http://research.microsoft.com/pubs/173922/appinsight.pdf">AppInsight</a>的论文仔细看了一遍，觉得确实是做得很好很有用的一个系统。我希望自己能把它实现在Android上。其实整个原理也不是非常的难，我想最难的部分在于Windows本来就有一个Detour可以直接利用来做instrumentation和interception，非常的方便，但是Java本身好像没有一个相当的库，需要自己实现一遍。</p>

<p>不知道这个计划需要多久才能完成，我可能要先找个和Detour功能类似的库改一改，希望这个作为自己第一个比较正式的开源项目不会中途破产吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redexer and Ocaml]]></title>
    <link href="http://ytliu.github.com/blog/2013/03/10/redexer-and-ocaml/"/>
    <updated>2013-03-10T09:53:00+08:00</updated>
    <id>http://ytliu.github.com/blog/2013/03/10/redexer-and-ocaml</id>
    <content type="html"><![CDATA[<p>在<a href="http://ytliu.github.com/blog/2013/03/01/dr-android-and-mr-hide-xidashiyin-fa-de-gu-shi/">上一篇博客</a>是一个用ruby和OCaml写的Dalvik binary rewriter，它提供了unparse, htmlunparse, id, combine, info, classes, api, opstat, cg, cfg, dom, pdom, dump_method等功能，还可以自己扩展相应的功能，具体的可以参看它的<a href="https://github.com/plum-umd/redexer">github主页</a>。</p>

<p>redexer主要原理就是将<code>.dex</code>文件按照<a href="http://source.android.com/tech/dalvik/dex-format.html">Dalvik Executable Format</a>映射到内存中的数据结构，然后根据这些数据结果进行分析，可以达到比较高的性能。</p>

<p>这里主要想要说说<a href="http://en.wikipedia.org/wiki/OCaml">OCaml</a>这个语言。</p>

<p>OCaml的全称是Object Caml，是一个有OO扩展的函数式语言（Functional Language），看了看它的语法，和我们程序语言理论里面的那个simPL非常的像，也和当时学FP的时候讲的Haskell很像。</p>

<p>查了查functional language和imperative language有什么不同，在wiki上似乎有一个最大的区别在于：</p>

<pre><code>It emphasizes the application of functions, in contrast to the imperative programming style, 
which emphasizes changes in state. The most significant differences stem from the fact that 
functional programming avoids side effects, which are used in imperative programming to implement 
state and I/O. 
</code></pre>

<p>然后在<a href="http://stackoverflow.com/questions/2078978/functional-programming-vs-object-oriented-programming">stack overflow</a>里面有一个蛮经典的回答”When do you choose functional programming over object oriented ?“</p>

<p><img src="http://ytliu.github.com/images/2013-03-10-1.png" title="answer" alt="stackoverflowans" /></p>

<p>另外，在OCaml里面有很多FP的特性，比如 static type system, type inference, parametric polymorphism, tail recursion, pattern matching, first class lexical closures, functors (parametric modules), exception handling, and incremental generational automatic garbage collection等等，这些会在之后对OCaml的学习中慢慢弄清楚来吧~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dr. Android and Mr. Hide - xidashi引发的故事]]></title>
    <link href="http://ytliu.github.com/blog/2013/03/01/dr-android-and-mr-hide-xidashiyin-fa-de-gu-shi/"/>
    <updated>2013-03-01T20:00:00+08:00</updated>
    <id>http://ytliu.github.com/blog/2013/03/01/dr-android-and-mr-hide-xidashiyin-fa-de-gu-shi</id>
    <content type="html"><![CDATA[<p>故事得从几天前利小哥发现的<a href="www.xidashi.com">xidashi</a>说起：</p>

<p><img src="http://ytliu.github.com/images/2013-03-01-1.png" title="xidashi" alt="xidashi" /></p>

<p>洗大师是一个android的安全应用软件+第三方应用市场，它的功能和特点简单来说就是：</p>

<blockquote><p>在不root的情况下，允许用户对已安装的应用程序实行权限的细粒度动态控制</p></blockquote>

<p>这里的细粒度动态控制是指用户可以随时允许或禁止该应用程序某一个权限，并对利用该权限调用API的行为进行log。</p>

<p>洗大师的流程是这样子的：</p>

<p>上传apk -> 服务器对apk进行”清洗“ -> 返回”清洗“过后的apk并安装 -> 在apk运行过程中进行动态权限控制</p>

<p>当然还有一种模式就是”直接下载洗大师market提供的应用“。</p>

<p>咋一看，这真的是一个非常牛逼的应用，在没有root的情况下可以对每个应用进行细粒度动态权限控制，这样用户就再也不用担心恶意程序利用过渡申请的权限做坏事了！</p>

<p>而且从实现上来看，利小哥刚开始写了一个很简单的测试程序，用洗大师”洗“了洗，发现它就加了一个包，而没有对原来的程序进行任何修改，我们都觉得不可思议！amazing！！！讨论了下觉得这是不可能的，然后斌哥就在网上找到了这一篇文章<a href="http://www.cs.umd.edu/~jfoster/papers/acplib.pdf">Dr. Android and Mr. Hide: Fine-grained security policies on unmodiﬁed Android</a>，这是一篇基于spsm2012的technical report，然后再重新写了个测试程序用洗大师”洗“了洗，发现其实它还是改了应用程序原来的binary的。于是乎，就感觉被骗了一样。不过仔细想来，其实洗大师这种方式不失为一种解决恶意程序权限泛滥的好办法，不知道洗大师的作者是看了这篇论文做出的洗大师还是自己想出来的，这种创业产品还是比较有效的，特别是如果它的第三方市场能够更加普及一点的话。当然啦，我们都觉得这个技术并不是一个高不可攀的技术，对于腾讯、360这种xx公司来说，要实现类似的功能应该还是挺快的。我去关注了下洗大师的新浪微博，发现它现在的粉丝并不多，不知道洗大师最后能牛逼到什么程度，祝君好运吧。</p>

<hr />

<p>扯了那么多闲话，开始进入正题，这一篇《Dr. Android and Mr. Hide》从效果上来说和洗大师还是有一点不同的，但是我觉得实现原理应该不会差太远，这里简单介绍下吧：</p>

<p>它的motivation是这样的：</p>

<p>现在Android的权限系统粒度太粗了，举个例子：如果一个应用程序，比如”大众点评“（点评躺着中枪了），申请了一个INTERNET权限，那么它就可以访问所有的网络了，但是实际上它只需要访问www.dianping.com这一个域名，那么一个恶意程序或者repackage的程序就可以利用它的网络权限窃取一些隐私数据传到某个服务器，这种方式并没有违反Android的权限系统。那么这篇paper的目的就是在不修改Android Framework的情况下将权限细化，比如把INTERNET改成InternetURL(d)，使得有后者权限的应用只能访问<code>d</code>这个URL。</p>

<p>这里需要说明的是，在这种安全防护模式下有两种方法可以做：</p>

<ul>
<li>修改Android Framework，换一种方式，从用户的角度来说也就是root，或者刷机；</li>
<li>对应用程序进行instrumentation，也就是将应用程序改一改，然后repackage一下。当然这个步骤应该是可以自动化的。</li>
</ul>


<p>对于前者来说，需要google或者一些设备提供商的支持，或者用户进行root；对于后者来说，谁来进行instrumentation，instrumentation产生的side effect都是需要考虑的问题。</p>

<p>这篇文章采用了第二种方式，而它的方法其实是很直观的：</p>

<p><img src="http://ytliu.github.com/images/2013-03-01-2.png" title="Mr. Hide" alt="mrhide" /></p>

<p><img src="http://ytliu.github.com/images/2013-03-01-3.png" title="Dr. Android" alt="drandroid" /></p>

<ul>
<li>首先，将apk中的粗粒度权限换成细粒度权限；</li>
<li>然后在apk中插入一个library（文中为hidelib），并通过一个自动化工具Dr. Android找出应用程序中所有对sensitive API的调用，将其换成hidelib中对应的API调用；</li>
<li>hidelib中的API会首先对应用的权限进行一个检查，然后和Mr. Hide进行交互，Mr. Hide是一个运行在另一个进程中的Service，它可以根据hidelib传送过来的信息进行相应的调用，并将结果返回。</li>
</ul>


<p>当然，这里面会牵扯到很多细节问题，比如应用程序怎么样和Mr. Hide进行binding，如何保护Mr. Hide不被恶意程序利用，以及如何精确而又高效地对原始apk进行instrumentation，还有很多Android中签名机制的问题等等，这里就不一一阐述了。</p>

<hr />

<p>值得一提的是，这篇paper中提到的Dr. Android是一个叫做<a href="http://www.cs.umd.edu/projects/PL/redexer/about.html">redexer</a>的开源项目，也就是作者开发的。redexer是一个用ruby和OCaml写的Dalvik Binary Rewriter，效率很高，功能也挺强大的。我在之后的博客中会对其进行一个介绍。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Traceview in Android]]></title>
    <link href="http://ytliu.github.com/blog/2013/02/23/traceview-in-android/"/>
    <updated>2013-02-23T15:54:00+08:00</updated>
    <id>http://ytliu.github.com/blog/2013/02/23/traceview-in-android</id>
    <content type="html"><![CDATA[<p>这两天尝试了下用Android自带的<a href="http://developer.android.com/tools/debugging/debugging-tracing.html">Traceview</a>进行profile，感觉蛮有意思的，而且发现它的文档上对数据格式的说明和我实现时候碰到的情况有出入，于是在google code上发了封<a href="https://code.google.com/p/android/issues/detail?id=51286">帖</a>（<a href="https://code.google.com/p/android/issues/detail?id=50930#makechanges">前一封</a>被华丽丽地无视掉了），但是到最后还是不明白到底是什么问题，维护文档的人好不热情啊...</p>

<p>反正这里还是按照我的实验情况来解释吧:-)</p>

<p>首先得解释下什么是Traceview。最简单而且最普遍的Traceview的流程是这样子的：</p>

<ul>
<li>用户首先要对源代码进行一些instrumentation，如下所示：</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c1">// start tracing to &quot;/sdcard/calc.trace&quot;</span>
</span><span class='line'><span class="n">Debug</span><span class="o">.</span><span class="na">startMethodTracing</span><span class="o">(</span><span class="s">&quot;calc&quot;</span><span class="o">);</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="c1">// stop tracing</span>
</span><span class='line'><span class="n">Debug</span><span class="o">.</span><span class="na">stopMethodTracing</span><span class="o">();</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>之后当运行到<code>Debug.startMethodTracing</code>时，系统就会进入Trace模式，在<code>/sdcard</code>目录下创建一个<code>calc.trace</code>文件，并动态地将之后的所有函数调用都trace进这个文件中（当然也包括framework中的API调用）；</li>
<li>然后就可以利用Android提供的Traceview工具或者dmtracedump工具对这个文件进行分析了。</li>
</ul>


<p>其中通过Traceview可以获得很多非常有用的信息，包括Timeline Panel和Profile Panel，具体的可以参见Traceview的<a href="http://developer.android.com/tools/debugging/debugging-tracing.html">document</a>，这里就不阐述了。而通过dmtracedump工具可以得到整个运行过程中的call-stack diagram。</p>

<p>不过目前的dmtracedump的call-graph功能还没有实现，于是我从网上找到一个用python脚本写的<a href="http://blog.csdn.net/zjujoe/article/details/6080738">dmtracedump替代</a>，一开始不能用，于是debug了一通，从而发现了前面说的和Traceview官方文档的出入。下面主要就是解释一下有何出入：</p>

<p>首先要介绍下官方文档中由Debug产生的Traceview的文件格式是怎样的：</p>

<p>cal.trace主要分为两个部分 —— key和data。</p>

<p>key部分的格式是这样的：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;em>version
</span><span class='line'>1
</span><span class='line'>clock=global
</span><span class='line'>&lt;/em>threads
</span><span class='line'>1 main
</span><span class='line'>6 JDWP Handler
</span><span class='line'>5 Async GC
</span><span class='line'>4 Reference Handler
</span><span class='line'>3 Finalizer
</span><span class='line'>2 Signal Handler
</span><span class='line'>&lt;em>methods
</span><span class='line'>0x080f23f8 java/io/PrintStream write ([BII)V
</span><span class='line'>0x080f25d4 java/io/PrintStream print (Ljava/lang/String;)V
</span><span class='line'>0x080f27f4 java/io/PrintStream println (Ljava/lang/String;)V
</span><span class='line'>0x080da620 java/lang/RuntimeException   &lt;init>    ()V
</span><span class='line'>[...]
</span><span class='line'>0x080f630c android/os/Debug startMethodTracing ()V
</span><span class='line'>0x080f6350 android/os/Debug startMethodTracing (Ljava/lang/String;Ljava/lang/String;I)V
</span><span class='line'>&lt;/em>end</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>它分为了3个sections，每一个section由<code>*</code>开头：</p>

<ul>
<li>version section;</li>
<li>threads section：主要记录了thread ID和thread Name，其中thread ID会在data部分中被引用；</li>
<li>methods section：主要记录了method ID和method signature，其中method ID用于被data部分的record引用。</li>
</ul>


<p>data部分的格式是这样的：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* File format:
</span><span class='line'>* header
</span><span class='line'>* record 0
</span><span class='line'>* record 1
</span><span class='line'>* ...
</span><span class='line'>*
</span><span class='line'>* Header format:
</span><span class='line'>* u4 magic 0x574f4c53 ('SLOW')
</span><span class='line'>* u2 version
</span><span class='line'>* u2 offset to data
</span><span class='line'>* u8 start date/time in usec
</span><span class='line'>*
</span><span class='line'>* Record format:
</span><span class='line'>* u1 thread ID
</span><span class='line'>* u4 method ID | method action
</span><span class='line'>* u4 time delta since start, in usec</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>它由heade和一系列的records组成，其中在header里面有一个域叫offset to data，由此可以找到第一个record的地址，而每一个record由三部分组成：</p>

<ul>
<li>thread ID：就是在key里面的那个thread ID；</li>
<li>method ID | method action：就是在key里面的那个method ID，method action有四种情况: {0->method entry; 1->method exit; 2->method exited by exception handling; 3->reversed};</li>
<li>time：就是这个action发生的时间，正常情况下时间都是按照升序排序的。</li>
</ul>


<p>有了这个trace文件以及事先协议好的格式，就可以进行分析了。即对每一个record进行遍历，得到每个时间点的函数调用，并将它们串起来，就可以得到很多信息。</p>

<p>但是在我的实验中，发现data部分中每个record不是像文档中描述的那样是由9个bytes组成的，而是14个bytes组成：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* Record format:
</span><span class='line'>* u2 thread ID
</span><span class='line'>* u4 method ID | method action
</span><span class='line'>* u8 time delta since start, in usec</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>我的猜想是和产生trace文件时机器的配置有关，我的系统是Debian 6.0，x86_64，维护文档的人似乎没有回答我，不过根据后面一个回答，好像确实在新的版本中就是14个bytes。</p>

<p>Anyway，不管怎么样，这个trace文件是可以提供非常多动态信息的，但是需要对源代码进行修改，并且可能会产生比较大的运行时overhead（自己猜的，没有验证）。不过按照文档上的说法还有一种方式是采用<a href="http://developer.android.com/tools/debugging/ddms.html">DDMS</a>，不过我也没有尝试过，就不在这里阐述了。</p>

<hr />

<p>另外，Python脚本我就不帖出来了，我用ruby重新实现了一遍，这是可以在我的机器上work的版本：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;dmtracedump.rb&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">turn</span> <span class="n">the</span> <span class="n">traceview</span> <span class="n">data</span> <span class="n">into</span> <span class="n">a</span> <span class="n">png</span> <span class="n">pic</span><span class="p">,</span> <span class="n">showing</span> <span class="nb">methods</span> <span class="n">call</span> <span class="n">relationship</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h6&gt;#&lt;/</span><span class="n">h6</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h6</span><span class="o">&gt;</span><span class="c1">##################  Global Variable&lt;/h6&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h6</span><span class="o">&gt;</span><span class="c1">#&lt;/h6&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="vi">@target_thread</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="vi">@all_threads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@all_methods</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@all_records</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="vi">@parent_methods</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@child_methods</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@method_calls</span> <span class="o">=</span> <span class="p">{}</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h6&gt;#&lt;/</span><span class="n">h6</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h6</span><span class="o">&gt;</span><span class="c1">########################   Methods&lt;/h6&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h6</span><span class="o">&gt;</span><span class="c1">#&lt;/h6&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">add_one_thread</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;fields = line.split(&quot;\t&quot;)</span>
</span><span class='line'><span class="sr">@all_threads[fields[0].to_i]=fields</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">add_one_method</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;fields = line.split(&quot;\t&quot;)</span>
</span><span class='line'><span class="sr">@all_methods[fields[0].to_i(16)]=fields</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">add_one_record</span><span class="p">(</span><span class="n">one</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;record = one.unpack(&quot;SLQ&quot;)</span>
</span><span class='line'><span class="sr">if record[0] == @target_thread</span>
</span><span class='line'><span class="sr">    method_id = (record[1] /</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
</span><span class='line'>    <span class="n">method_action</span> <span class="o">=</span> <span class="n">record</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">%</span> <span class="mi">4</span>
</span><span class='line'>    <span class="vi">@all_records</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="o">[</span><span class="n">record</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">method_id</span><span class="p">,</span> <span class="n">method_action</span><span class="p">,</span> <span class="n">record</span><span class="o">[</span><span class="mi">2</span><span class="o">]]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;def handle_one_call(parent_method_id, method_id)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c1"># p &quot;#{parent_method_id} -&amp;gt; #{method_id}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">!</span><span class="vi">@parent_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@parent_methods</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span>  <span class="o">!</span><span class="vi">@child_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@child_methods</span><span class="o">[</span><span class="n">method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="vi">@method_calls</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">].</span><span class="n">has_key?</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">][</span><span class="n">method_id</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">][</span><span class="n">method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>    <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">][</span><span class="n">method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;def gen_funcname(method_id)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">cla_med</span> <span class="o">=</span> <span class="vi">@all_methods</span><span class="o">[</span><span class="n">method_id</span><span class="o">][</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[\/\$&amp;lt;&amp;gt;]/</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">sub_med</span> <span class="o">=</span> <span class="vi">@all_methods</span><span class="o">[</span><span class="n">method_id</span><span class="o">][</span><span class="mi">2</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[\/\$&amp;lt;&amp;gt;]/</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span class='line'><span class="s2">&quot;</span><span class="si">#{</span><span class="n">cla_med</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">sub_med</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;def gen_dot_script_file&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">ofile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;graph.dot&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;digraph vanzo {</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@all_methods</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@parent_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span class='line'>        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">  [shape=rectangle];</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@child_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span class='line'>            <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">  [shape=ellipse];</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@method_calls</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>    <span class="vi">@method_calls</span><span class="o">[</span><span class="nb">p</span><span class="o">].</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class='line'>        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&amp;gt; </span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2"> [label=&#39;</span><span class="si">#{</span><span class="vi">@method_calls</span><span class="o">[</span><span class="nb">p</span><span class="o">][</span><span class="n">c</span><span class="o">].</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&#39; fontsize=&#39;10&#39;];</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">ofile</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h6&gt;#&lt;/</span><span class="n">h6</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h6</span><span class="o">&gt;</span><span class="c1">#################### Script starts from here&lt;/h6&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h6</span><span class="o">&gt;</span><span class="c1">#&lt;/h6&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">1</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;print &quot;No input file specified.&quot;</span>
</span><span class='line'><span class="sr">exit</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;p &quot;input file not exists&quot;</span>
</span><span class='line'><span class="sr">exit</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Now</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">text</span> <span class="n">part</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;current_section = 0</span>
</span><span class='line'><span class="sr">lines = File.readlines(ARGV[0])</span>
</span><span class='line'><span class="sr">lines.each { |line|&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">line</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'><span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*version&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">current_section</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*threads&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">current_section</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*methods&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">current_section</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*end&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">current_section</span> <span class="o">=</span> <span class="mi">4</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">elsif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">add_one_thread</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'><span class="k">elsif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="mi">3</span>
</span><span class='line'>    <span class="n">add_one_method</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;Now handle the binary part&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">alldata</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;alldata = File.read(ARGV[0])&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">alldata</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;SLOW&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="n">alldata</span><span class="o">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="n">pos</span> <span class="o">+=</span> <span class="n">offset</span> <span class="c1">#where the record begin</span>
</span><span class='line'><span class="n">record_num</span> <span class="o">=</span> <span class="n">alldata</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">pos</span>
</span><span class='line'><span class="n">record_num</span> <span class="o">/=</span> <span class="mi">14</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">record_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;add_one_record(alldata[pos+i*14, 14])</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;}&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">my_stack</span> <span class="o">=</span> <span class="o">[</span><span class="mi">0</span><span class="o">]&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;@all_records.each { |onerecord|&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="n">method_id</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="n">action</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="n">time</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">my_stack</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">parent_method_id</span> <span class="o">=</span> <span class="n">my_stack</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>        <span class="n">handle_one_call</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">,</span> <span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">my_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">my_stack</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">1</span>
</span><span class='line'>            <span class="n">my_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;gen_dot_script_file</span>
</span><span class='line'><span class="sr">os.system(&quot;dot -Tjpg graph.dot -o output.png;rm -f graph.dot&quot;);&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>用法：</p>

<pre><code>$ ruby dmtracedump.rb calc.trace
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Qemu study for Android emulator]]></title>
    <link href="http://ytliu.github.com/blog/2012/12/30/qemu-study-for-android-emulator/"/>
    <updated>2012-12-30T19:10:00+08:00</updated>
    <id>http://ytliu.github.com/blog/2012/12/30/qemu-study-for-android-emulator</id>
    <content type="html"><![CDATA[<p>这两天看了下android emulator的源代码，位置在<code>android-src/external/qemu</code>里面，</p>

<p>编译和启动的方式很简单；</p>

<pre><code>$ ./android-configure.sh
$ make
$ export ANDROID_SDK_ROOT=/path/to/androdi-sdk
$ emulator-arm @4.2
</code></pre>

<p>你可以对源码进行修改，然后重新编译、使用，而这里主要要讲的是qemu的运行原理，资料来源是<a href="http://lists.gnu.org/archive/html/qemu-devel/2011-04/pdfhC5rVdz7U8.pdf">Qemu detailed study</a>。要说明的一点是，android emulator原理基本上是和qemu一样的，只是加了一些android specific的东西在里面。</p>

<p>首先是qemu整体流程：</p>

<p><img src="http://ytliu.github.com/images/2012-12-30-1.png" title="qemu process" alt="qemu process" /></p>

<p>首先将guest code（这里即为arm code）被TCG（Tiny Code Generator)转换成一个中间表达，然后再转换成host code（这里即为x86 code），具体来说分为两步：</p>

<ul>
<li>一个TB（Translation Block）被翻译成TCG ops</li>
<li>TCG ops被翻译成host code</li>
</ul>


<p>我们先来看下qemu的code base：</p>

<p><img src="http://ytliu.github.com/images/2012-12-30-2.png" title="qemu code base" alt="qemu code base" /></p>

<ul>
<li><code>vl.c/vl-android.c</code>: 这个是整个qemu的入口函数，主要是初始化qemu环境，然后进入<code>main_loop</code>；</li>
<li><code>target-xyz/translate.c</code>: 将guest code翻译成TCG ops；</li>
<li><code>tcg/*/tcg-target.c</code>: 将TCG ops翻译成host code；</li>
<li><code>tcg/tcg.c</code>: TCG的主函数；</li>
<li><code>cpu-exec.c</code>: 寻找下一个TB（如果没找到则调用tcg.c生成TB），然后执行。</li>
</ul>


<p>在qemu中也很好地利用了locality，即没产生一段code（TCG ops或host code），就将其存在一个code cache中，然后用LRU进行替换。</p>

<h4>运行流程（code perspective）</h4>

<p>主要分为两部分： <em>代码生成</em>和<em>代码运行</em></p>

<h5>代码生成</h5>

<p>这是主要部分，流程是这样的：</p>

<p><img src="http://ytliu.github.com/images/2012-12-30-3.png" title="qemu process from code perspective" alt="qemu process from code perspective" /></p>

<p>其中函数<code>cpu_exec()</code>相当于主要的执行循环函数，它将TB第一次初始化，在两个嵌套无限for循环中通过<code>tb_find_fast()</code>来获得host code TB，然后通过<code>tcg_qemu_tb_exec()</code>来执行相应代码。</p>

<p><code>tb_find_fast</code>会首先查看code cache中是否有TB存在了，有则直接执行<code>tcg_qemu_tb_exec()</code>，否则通过<code>tb_find_slow()</code>来查找或者生成TB，后者通过一系列调用，最后到达<code>disas_insn()</code>，该函数执行了实际的guest code到TCG ops的翻译，并将其加入TCG ops的code buffer，最后调用<code>tcg_gen_code()</code>来生成host code。</p>

<h5>代码运行</h5>

<p>代码运行就是通过<code>tcg_qem_tb_exec()</code>来实现的，可以看到，其实这是一个宏，定义在<code>tcg/tcg.h</code>里面：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">define</span> <span class="n">tcg_qemu_tb_exec</span><span class="p">(</span><span class="n">tb_ptr</span><span class="p">)</span> <span class="err">\</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">long</span> <span class="n">REGPARM</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">longcall</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="n">code_gen_prologue</span><span class="p">)(</span><span class="n">tb_ptr</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>这是一个感觉非常复杂的调用，我们知道， <code>((long REGPARM (*)(void *))</code> 是一个指向函数的指针，<code>void *</code>是它的参数，返回值为<code>long</code>；而在这里 <code>REGPARAM(*)</code>是一个GCC选项，表示函数是通过寄存器传参而不是通过栈传参的。</p>

<p>而一个数组的名字表示的是指向这个数组的基地址，于是，<code>(function_pointer) array_name</code>则会将这个基地址cast成一个函数地址。</p>

<p>另外，一个函数可以通过<code>(*pointer_to_func)(args)</code>被调用，所以<code>((long REGPARM (*)(void *))code_gen_prologue)(tc_ptr)</code>进行了一次函数调用，似乎在这里少了一个<code>*</code>号，不过其实只要测试下可以发现 <code>(*pointer_to_func)(args)</code>和<code>(pointer_to_func)(args)</code>是一样的。</p>

<p>所以上面<code>tcg_qemu_tb_exec(tb_ptr)</code>翻译的宏可以表示为一个数组<code>code_gen_prologue</code>被cast成一个函数指针，参数为<code>tc_ptr</code>，返回值为<code>long</code>（指向下一个TB），并且被调用。其实，被<code>code_gen_prologue</code>指向的函数就是<code>Function Prologue</code>，将控制流转到<code>tc_ptr</code>指向的host code开头部分。</p>
]]></content>
  </entry>
  
</feed>
