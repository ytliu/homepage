
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mctrain's Blog</title>
  <meta name="author" content="Liu Yutao">

  
  <meta name="description" content="在之前研究了那么久的bindService()这个API，一直没搞清楚一个问题： 为什么我看到的基本上都是和AMS相关的代码，而之前所学到说如果application要和service打交道都是需要通过ServiceManager获得某个service的binder才可以。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ytliu.github.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mctrain's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mctrain's Blog</a></h1>
  
    <h2>Security, Virtualization, Network, as well as life moments</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="ytliu.cc@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ytliu.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/11/getsystemservice-in-android/">getSystemService() in Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-11T20:18:00+08:00" pubdate data-updated="true">Nov 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在之前研究了那么久的bindService()这个API，一直没搞清楚一个问题：</p>

<p>为什么我看到的基本上都是和AMS相关的代码，而之前所学到说如果application要和service打交道都是需要通过ServiceManager获得某个service的binder才可以。那么AMS和ServiceManager到底是什么关系呢？如果AMS是通过ServiceManager获得的service binder，那么相关的代码又是在哪里呢？</p>

<p>这个问题困扰了我很久，直到我看到一个<a href="http://blog.csdn.net/windskier/article/details/6625883" title="杜文涛的专栏">博客</a>，我才发现其实我把一个很重要的概念混起来了：</p>

<p>Android中主要通过2种方法来获得service binder：</p>

<ul>
<li>通过一些API如bindService，来获得application service的binder。因为app service都是直接和AMS注册的，AMS运行在system_server进程；</li>
<li>通过ServiceManager.getService(String Descriptor)来获得Service Manager管理的service的binder，ServiceManager运行在servicemanager进程。</li>
</ul>


<p>也就是说，尼玛bindService只是用来bind application level的service！！！</p>

<p>而我们更在意的system service应该是由ServiceManager.getService()来获得的！！！</p>

<p>发现这个问题之后我整个人都有些凌乱了。。。不过静下来想想其实自己从bindService这里入手也学到很多东西，也就不纠结了！</p>

<p>那么现在的问题是，应用程序到底是如何获得system service的binder的？</p>

<p>在这个问题的探索过程初期，我又一次惊奇地发现android.os.ServiceManager竟然是@hide的！！！！</p>

<p>尼玛hide的啊！！！也就是如果不是和framework一起编译的话是找不到的啊！我在网上看到一个很无语的<a href="http://www.oschina.net/question/54100_32232?sort=time" title="隐藏类的使用">解决方案</a>，但是，我还是不知道应用程序到底是怎么调用system service的啊？总不可能每个人都懂得什么变态的“隐藏类的使用”吧？</p>

<p>后来不知道是怎么回事，我突然发现在android里面竟然有一个API叫getSystemService()！我问了下乃正，他竟然和我说“你们干嘛不问我，这不是很显然的吗？应用里面就是调用这个获得system service的啊”！尼玛伤不起啊，一个没写过android应用程序的还要研究android framework的人伤不起啊！！</p>

<hr />

<h3>getSystemService()</h3>

<p>好了，还是言归正传吧，到底getSystemService()是如何得到system service的呢？其实这个也没有想象的那么好理解。而且我查了下网上的资料，大部分还是讲ServiceManager.getService()是如何得到system service的，而基本上都没有涉及到getSystemService()是怎么和ServiceManager.getService()搭上关系的。</p>

<p>于是经过一番研究，我终于搞清楚了这里面所涉及的种种“复杂而又充满基情”的关系，请听我娓娓道来：</p>

<hr />

<p>在一个月黑风高的夜晚，一个郁郁不得志的少年Activity调用了一个具有扭转乾坤概率的大API&#8212;getSystemService()。</p>

<p>算了，没有写小说的潜质。。。还是老实点正常写着吧。。。早点写完早点洗洗睡吧。。。</p>

<p>在调用Activity.getSystemService()之后，就进入ContextImpl.getSystemService()。</p>

<p>至于是怎么进来的，其实也很简单，Activity继承ContextThemeWrapper，再继承ContextWrapper。里面会调用mBase.getSystemService()。这个mBase是一个ContextImpl实例变量，于是就调到了。</p>

<p>于是在ContextImpl.getSystemService()是这样的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getSystemService</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ServiceFetcher</span> <span class="n">fetcher</span> <span class="o">=</span> <span class="n">SYSTEM_SERVICE_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">fetcher</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">fetcher</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>话说这个SYSTEM_SERVICE_MAP是怎么来的呢？这就要扯得远点了：</p>

<p>在每个Activity启动的时候都要运行一大段的static的代码（在android.app.ContextImpl.java）里面：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">registerService</span><span class="o">(</span><span class="n">ACCESSIBILITY_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">ServiceFetcher</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">AccessibilityManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">registerService</span><span class="o">(</span><span class="n">ACCOUNT_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">ServiceFetcher</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">public</span> <span class="n">Object</span> <span class="nf">createService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">IBinder</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">ACCOUNT_SERVICE</span><span class="o">);</span>
</span><span class='line'>      <span class="n">IAccountManager</span> <span class="n">service</span> <span class="o">=</span> <span class="n">IAccountManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">AccountManager</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">registerService</span><span class="o">(</span><span class="n">ACTIVITY_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">ServiceFetcher</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">public</span> <span class="n">Object</span> <span class="nf">createService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">ActivityManager</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">getOuterContext</span><span class="o">(),</span> <span class="n">ctx</span><span class="o">.</span><span class="na">mMainThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}});</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>它会在自己的SYSTEM_SERVICE_MAP为每一个系统服务注册一个ServiceFetcher的类，在这个类中，大部分的服务为重写一个函数叫<em>createService(ContextImpl)</em>，这个方法之后会用到，现在只需要知道我们从SYSTEM_SERVICE_MAP获得了某个服务的ServiceFetcher对象fetcher，并通过fetcher.getService(this)获得了该服务的对象。</p>

<p>fetcher.getService(ContextImpl):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">mServiceCache</span><span class="o">;</span>
</span><span class='line'>    <span class="n">Object</span> <span class="n">service</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// Initialize the cache vector on first access.</span>
</span><span class='line'>      <span class="c1">// At this point sNextPerContextServiceCacheIndex</span>
</span><span class='line'>      <span class="c1">// is the number of potential services that are</span>
</span><span class='line'>      <span class="c1">// cached per-Context.</span>
</span><span class='line'>      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sNextPerContextServiceCacheIndex</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">cache</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">service</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mContextCacheIndex</span><span class="o">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">service</span> <span class="o">=</span> <span class="n">createService</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span><span class='line'>  <span class="n">cache</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">mContextCacheIndex</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说每个Activity都有一个mServiceCache，它cache了所有用到的service的ServiceFetcher类。如果hit了，那么直接返回该对象，否则会调用这个fetcher的createService()方法，这也就是我们刚才提到的每一个ServiceFetcher在注册的时候会重写的那个方法。</p>

<p>可以看到，大部分重写的方式都是类似于这样的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">createService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">IBinder</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">XXX_SERVICE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">IXXXManager</span> <span class="n">service</span> <span class="o">=</span> <span class="n">IXXXManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">XXXManager</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
</span><span class='line'><span class="o">}});</span>
</span></code></pre></td></tr></table></div></figure>


<p>于是乎，getSystemService()就在这里和ServiceManager.getService()无缝地结合在了一起！</p>

<hr />

<p>对于ServiceManager.getService()，在网上有很多关于它的说明和讨论，这里推荐其中两篇：</p>

<p>在<a href="http://blog.csdn.net/Luoshengyang" title="老罗的android之旅">老罗</a>的博客中两篇，</p>

<p>第一篇是<a href="http://blog.csdn.net/luoshengyang/article/details/6642463" title="java API">这篇文章</a>，主要介绍了怎么从java里面的ServiceManager.getService()开始的流程；</p>

<p>还有一篇是<a href="http://blog.csdn.net/luoshengyang/article/details/6633311" title="getService">这篇文章</a>，深入介绍了在C++和driver层是如何调用getService的</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/03/parcel-object-in-android/">Parcel Object in Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-03T21:42:00+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>还记得之前被Android Framework里面的那个Parcel类搞得很摸不清头脑，这次为了完成一个任务把它彻底理了一遍，终于弄清楚了很多。</p>

<p>要做的事是这样子的：我有一个经过Parcel封装过的数据data，我需要通过socket把它发送到远程的一个进程中去进行处理，再返回一个Parcel对象reply。</p>

<p>首先在做这个之前我们先来看下Parcel在android中的用法和实现：</p>

<h5>用法</h5>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
</span><span class='line'>    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
</span><span class='line'>    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_result</span><span class="o">;</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
</span><span class='line'>  <span class="n">_data</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class='line'>  <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="n">Stub</span><span class="o">.</span><span class="na">TRANSACTION_sayHello</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>  <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
</span><span class='line'>  <span class="n">_result</span> <span class="o">=</span> <span class="n">_reply</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是一段用的最多的code，我们在android中的BinderProxy对象中调用一个sayHello()方法，它会首先封装一个Parcel对象，并将其作为参数调用transact()函数，通过android的Binder机制传到另一个进程的BBinder的onTransact()函数中：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">INTERFACE_TRANSACTION:</span>
</span><span class='line'>      <span class="o">{</span>
</span><span class='line'>      <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">TRANSACTION_sayHello:</span>
</span><span class='line'>      <span class="o">{</span>
</span><span class='line'>      <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
</span><span class='line'>      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_arg0</span><span class="o">;</span>
</span><span class='line'>      <span class="n">_arg0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
</span><span class='line'>      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="n">_arg0</span><span class="o">);</span>
</span><span class='line'>      <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
</span><span class='line'>      <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">_result</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而这两个进程数据的传递是在driver里面通过内存拷贝进行的。</p>

<p>那么如果我希望不通过binder driver而直接将Parcel对象data通过socket传到另一个进程那么该怎么办呢？大家都知道在Java里面要传递一个数据，该数据必须得是Serializable的。那么Parcel类是这样的吗？</p>

<p>需要先来看看Parcel的实现:</p>

<h5>实现</h5>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Parcel</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">dataSize</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">dataPosition</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">marshall</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">unmarshall</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offest</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">writeInterfaceToken</span><span class="o">(</span><span class="n">String</span> <span class="n">interfaceName</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">enforceInterface</span><span class="o">(</span><span class="n">String</span> <span class="n">interfaceName</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">writeString</span><span class="o">(</span><span class="n">String</span> <span class="n">val</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">readString</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先可以看到Parcel并没有implements Serializable，同时它的方法都是JNI方法，可以在frameworks/base/core/jni/android_util_Binder.cpp里面找到，这里以writeString()为例：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">android_os_Parcel_writeString</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">val</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Parcel</span><span class="o">*</span> <span class="n">parcel</span> <span class="o">=</span> <span class="n">parcelForJavaObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">parcel</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">NO_MEMORY</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">const</span> <span class="n">jchar</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringCritical</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">err</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">writeString16</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringLength</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span><span class='line'>                <span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleaseStringCritical</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">err</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">writeString16</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">signalExceptionForError</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>里面调用了Parcel的writeString16()这个方法，而这个Parcel是一个C类，实现在frameworks/base/libs/binder/Parcel.cpp里面：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">status_t</span> <span class="n">Parcel</span><span class="o">::</span><span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="n">char16_t</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">writeInt32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">writeInt32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">char16_t</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">writeInplace</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">char16_t</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>            <span class="o">*</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">char16_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">err</span> <span class="o">=</span> <span class="n">mError</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">status_t</span> <span class="n">Parcel</span><span class="o">::</span><span class="n">writeInt32</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">val</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">writeAligned</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">template</span><span class="o">&lt;</span><span class="n">class</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">status_t</span> <span class="n">Parcel</span><span class="o">::</span><span class="n">writeAligned</span><span class="p">(</span><span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">COMPILE_TIME_ASSERT_FUNCTION_SCOPE</span><span class="p">(</span><span class="n">PAD_SIZE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">mDataPos</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mDataCapacity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="nl">restart_write:</span>
</span><span class='line'>        <span class="o">*</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">mData</span><span class="o">+</span><span class="n">mDataPos</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">finishWrite</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">growData</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="k">goto</span> <span class="n">restart_write</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="n">Parcel</span><span class="o">::</span><span class="n">writeInplace</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">padded</span> <span class="o">=</span> <span class="n">PAD_SIZE</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// sanity check for integer overflow</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">mDataPos</span><span class="o">+</span><span class="n">padded</span> <span class="o">&lt;</span> <span class="n">mDataPos</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">mDataPos</span><span class="o">+</span><span class="n">padded</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">mDataCapacity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="nl">restart_write:</span>
</span><span class='line'>        <span class="c1">//printf(&quot;Writing %ld bytes, padded to %ld\n&quot;, len, padded);</span>
</span><span class='line'>        <span class="kt">uint8_t</span><span class="o">*</span> <span class="k">const</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mData</span><span class="o">+</span><span class="n">mDataPos</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Need to pad at end?</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">padded</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#if BYTE_ORDER == BIG_ENDIAN</span>
</span><span class='line'>            <span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">mask</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="mh">0xffff0000</span><span class="p">,</span> <span class="mh">0xff000000</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if BYTE_ORDER == LITTLE_ENDIAN</span>
</span><span class='line'>            <span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">mask</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00ffffff</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="mh">0x000000ff</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>            <span class="c1">//printf(&quot;Applying pad mask: %p to %p\n&quot;, (void*)mask[padded-len],</span>
</span><span class='line'>            <span class="c1">//    *reinterpret_cast&lt;void**&gt;(data+padded-4));</span>
</span><span class='line'>            <span class="o">*</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="n">padded</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">[</span><span class="n">padded</span><span class="o">-</span><span class="n">len</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">finishWrite</span><span class="p">(</span><span class="n">padded</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">growData</span><span class="p">(</span><span class="n">padded</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="k">goto</span> <span class="n">restart_write</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实整个Parcel的实现是这样的，每一个Parcel对象有一个指针mData，指向一块内存的起始地址，一个指针mDataPos，指向到目前未知已经读到的数据的大小。在写一个String的时候，首先将字符串的大小通过writeInt32()写到某个合适的内存地址中：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">mDataPos</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mDataCapacity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="nl">restart_write:</span>
</span><span class='line'>        <span class="o">*</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">mData</span><span class="o">+</span><span class="n">mDataPos</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">finishWrite</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后通过writeInplace将字符串按照合适的Align方式写到之后的内存地址中：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">writeInplace</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">char16_t</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>  <span class="o">*</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">char16_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后更新相对应的mDataSize和mDataPos值。</p>

<hr />

<h6>Parcel对象的序列化</h6>

<p>也就是说我们在java层是没有办法不通过其提供的接口获得一个Parcel对象内存中的数据的，也就是说如果我们需要将Parcel对象通过socket传输，就只有两种方式：</p>

<ul>
<li>在jni层进行socket传输；</li>
<li>手动对其进行序列化，并将序列化的数据通过socket传输过去。</li>
</ul>


<p>其实细心的人可以发现我刚刚在列举Parcel的一系列jni方法的时候还列举了两个方法：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Parcel</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">marshall</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">unmarshall</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offest</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这两个方法在jni里面是这样实现的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="n">jbyteArray</span> <span class="nf">android_os_Parcel_marshall</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Parcel</span><span class="o">*</span> <span class="n">parcel</span> <span class="o">=</span> <span class="n">parcelForJavaObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">parcel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// do not marshall if there are binder objects in the parcel</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">parcel</span><span class="o">-&gt;</span><span class="n">objectsCount</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">jniThrowException</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;java/lang/RuntimeException&quot;</span><span class="p">,</span> <span class="s">&quot;Tried to marshall a Parcel that contained Binder objects.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">jbyteArray</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewByteArray</span><span class="p">(</span><span class="n">parcel</span><span class="o">-&gt;</span><span class="n">dataSize</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">jbyte</span><span class="o">*</span> <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">jbyte</span><span class="o">*</span><span class="p">)</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetPrimitiveArrayCritical</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">array</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">memcpy</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">(),</span> <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">dataSize</span><span class="p">());</span>
</span><span class='line'>            <span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleasePrimitiveArrayCritical</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">android_os_Parcel_unmarshall</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jbyteArray</span> <span class="n">data</span><span class="p">,</span> <span class="n">jint</span> <span class="n">offset</span><span class="p">,</span> <span class="n">jint</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Parcel</span><span class="o">*</span> <span class="n">parcel</span> <span class="o">=</span> <span class="n">parcelForJavaObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">parcel</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">jbyte</span><span class="o">*</span> <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">jbyte</span><span class="o">*</span><span class="p">)</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetPrimitiveArrayCritical</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">setDataSize</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
</span><span class='line'>        <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">setDataPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">void</span><span class="o">*</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">writeInplace</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
</span><span class='line'>        <span class="n">memcpy</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="p">(</span><span class="n">array</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleasePrimitiveArrayCritical</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>marshall和unmarshall正是两个Parcel提供的将其自身进行序列化和反序列化的方法，marshall()将其本身转换成一个byte[]数据序列，即将mData指向内存中的值通过内存拷贝的形式传到一个byte[]变量中去并返回，而unmarshall()则是将byte[]变量中的数据拷贝到Parcel对象的mData指向内存中。</p>

<p>也就是说，我们可以通过marshall方法将data序列化成byte[]变量dataBytes，通过socket的write传递到远端，在远端通过unmarshall方法将其转换回来。</p>

<p>另外通过实现，发现还有一个需要注意的地方，在远端通过unmarshall对象转换回来的时候，还需要调用data.setDataPosition(0)将mDataPos设成初始未知，否则之后无法读取正常的数据。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/27/goagent-setup-note/">GoAgent Setup Note</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-27T12:21:00+08:00" pubdate data-updated="true">Oct 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这次去武汉开会的时候听翔哥提到GoAgent很好用，就尝试着去搭了下环境。</p>

<p><a href="http://irising.me/2012/02/13376/%20GoAgent">原文地址</a></p>

<p>说实话这个环境搭起来真的很方便，主要分为四步：</p>

<ul>
<li><p>申请Google App Engine的请用，这个就不细说了，具体参看原文，唯一一个要注意的是在里面有一个Storage Schema的选项要选择High Replication (我之前注册的应用没有这一项，要转变成这个还挺麻烦的)。</p></li>
<li><p>安装GoAgent的客户端：代码的地址在<a href="http://code.google.com/p/goagent/">这里</a>，然后要修改local目录下的proxy.ini文件，之后要安装一个证书（不过据说不安装也行）。最后上传到GAE上：</p>

<p>  $ cd goagent/server</p>

<p>  $ python uploader.zip update ./</p></li>
</ul>


<p>会在后面提示输入appid和GAE账户信息。</p>

<ul>
<li><p>设置代理：新建一个网络位置，例如：命名为代理，并将Web代理、安全Web代理两项勾选上，代理服务器地址均为，127.0.0.1,端口为8087。</p></li>
<li><p>GoAgent使用：首先先在终端运行如下命令：</p>

<p>  $ cd goagent/local</p>

<p>  $ python proxy.python</p></li>
</ul>


<p>然后再在苹果菜单下切换location成代理。</p>

<p>这样就可以通过GoAgent上网了。</p>

<h4>GoAgentX</h4>

<p>由于这个需要每次都在终端下输入命令，切换网络位置，最关键的是如果换了一个代理服务器的地址的话还要手动更新，所以在P哥的推荐下我选择了使用GoAgentX，这个是GoAgent的图形界面版，而且可以自动更新，十分方便。</p>

<h6>安装</h6>

<p>下载地址在<a href="https://github.com/downloads/ohdarling/GoAgentX/GoAgentX-v1.3.6.dmg%20GoAgentX">这里</a>，直接点击安装就可以了。然后会在桌面上方的任务栏里有个戴帽子的小人图像出现，点击显示主窗口，在服务配置里面修改端口和appid，在代理配置里面勾选“不修改系统代理配置”，之后启动，并修改网络位置就可以了。</p>

<hr />

<p>我感觉苹果电脑配置这些东西都非常的方便，而且程序运行的也很稳定，相当赞啊~</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/20/regain-my-vms-account/">Regain My VM&#8217;s Account</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-20T13:53:00+08:00" pubdate data-updated="true">Oct 20<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这两天在做opennebula项目的时候遇到一个问题，我忘记掉之前那几个虚拟机的用户密码了！试了好多可能的密码都不对，只能想办法把密码改掉了。</p>

<p>虚拟机的好处在于我可以把它直接mount到物理主机上对其进行操作，不过镜像文件不是一个普通的设备块，不能通过一般的方法mount，只能用不一般的方法了：</p>

<p>首先我有两种镜像，一个是普通的qemu镜像，以.img结尾的文件，一种是KVM的qcow2文件。</p>

<h5>.img镜像</h5>

<p>对于第一种，飞机教了我一个办法：</p>

<pre><code>$ fdisk -l vm.img
Disk datastores/vm.img: 8589 MB, 8589934592 bytes
255 heads, 63 sectors/track, 1044 cylinders, total 16777216 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x0004bacc
Device Boot      Start         End      Blocks   Id  System
datastores/vm3.img1   *        2048    15958015     7977984   83  Linux
datastores/vm3.img2        15960062    16775167      407553    5  Extended
datastores/vm3.img5        15960064    16775167      407552   82  Linux swap / Solaris
</code></pre>

<p>注意里面的一个数2048，然后执行下面一条指令：</p>

<pre><code>$ mount -o offset=$((2048*512)),loop vm.img /mnt
</code></pre>

<p>然后就mount到/mnt上去了。</p>

<h5>.qcow2镜像</h5>

<p>第二种镜像得用另外一个方法，这个是从<a href="http://blog.loftninjas.org/2008/10/27/mounting-kvm-qcow2-qemu-disk-images/">这里</a>看到的：</p>

<p>首先要先aptitude install 一个nbd-client，通过</p>

<pre><code>$ sudo modprobe nbd max_part=8
$ sudo qemu-nbd --connect=/dev/nbd0 vm.qcow2
$ sudo fdisk /dev/nbd0
$ sudo mount /dev/nbd0p1 /mnt
</code></pre>

<p>即完成了mount，当然我对其中的原理也不太了解就是了。</p>

<h5>chroot</h5>

<p>最后是如何改密码，我是痛过chroot来做的，这里想简单介绍下这个命令：</p>

<p>刚开始我直接运行：</p>

<pre><code>$ sudo chroot .
</code></pre>

<p>然后报了一个这个错误：</p>

<pre><code>chroot: failed to run command `/bin/zsh': No such file or directory`
</code></pre>

<p>之后了解了chroot的<a href="http://www.ibm.com/developerworks/cn/linux/l-cn-chroot/">工作流程</a>才知道这是怎么回事：</p>

<p>一个相对完整的chroot流程是这样的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">){</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: chroot NEWROOT [COMMAND...] </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;newroot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">chroot</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">perror</span><span class="p">(</span><span class="s">&quot;chroot&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">chdir</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">perror</span><span class="p">(</span><span class="s">&quot;chdir&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;SHELL&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>      <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;-i&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">argv</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">execvp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;chroot: cannot run command `%s`</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">argv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在chdir之后会先看看用户有没有指定特定的shell，如果没有则根据环境变量中的SHELL来指定相同的shell，否则会使用用户指定的shell运行（argv += 2)。由于我原来用户的shell是<em>/bin/zsh</em>, 且我没有指定特定的shell，所以在chroot之后就默认使用<em>/bin/zsh</em>，但是在这个镜像的文件系统中并没有<em>/bin/zsh</em>，所以就会报错。</p>

<p>所以我只需要（1）将环境变量中的shell设成<em>/bin/bash</em>或者（2）指定一个shell（$ sudo chroot . /bin/bash）就可以了</p>

<p>之后就可以通过运行</p>

<pre><code>$ passwd root
</code></pre>

<p>来改变root的密码了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/12/android-messaging-mechanism/">Android Messaging Mechanism</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-12T21:43:00+08:00" pubdate data-updated="true">Oct 12<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这两天做remote binder遇到一个bug，具体是什么就不细说了，总之是和android的message机制相关，在Handler.java里面通过mQueue.enqueueMessage()成功后却没有办法从Looper.java里面的mQueue.next()中读出该条message。搞了半天，打印了一堆log，最后发现竟然是因为Looper的线程被我自己block住了。这个主要是由于自己对其理解的错误造成的，之前我一直以为对于每个Activity（或Service）来说，除了主线程之外，都会有一个专用的Looper线程进行消息队列的轮询，今天和乃正讨论了下，其实不是这样的。对于一个进程来说，如果你没有需求说需要有某个线程做某些特定的事（比如socket监听），那么你的主线程就会进入Looper循环进行消息队列的轮询，否则你就需要自己再新建一个线程，或者重新开一个looper，或者进行socket监听&#8230;</p>

<p>此外还有一点，looper是thread local的，对于这个的理解，应该是这样的：在每个线程新建之后，都会有一个原来线程的mQueue的引用，而如果你要自己做一些特定的事，比如重新开一个新的Looper进行其它消息的轮询，那么没有问题，你新建一个looper，但是要注意，你的mQueue是唯一的，也就是说，你之前的对原来线程的mQueue的引用就没了，也就是说，对于一个线程来说只可能有唯一的mQueue。</p>

<p>之后就是message的流程。有两种可能的情况：</p>

<ul>
<li>sendMessage(): 这是最常见的形式，这个msg就是一个普通的message，它会依次调用sendMessageDelayed(), sendMessageAtTime(), queue.enqueueMessage()，最后将消息插到队列中去。</li>
<li>post(): 我这次遇到的就是这种形式，在ServiceDispatcher中用到的就是它，它传递的message是一个Runnable对象，叫RunConnection，在post里面会逐步调用sendMessageDelayed(), sendMessageAtTime(), queue.enqueueMessage()，并且会将msg.callback设成RunConnection对象。</li>
</ul>


<p>之后在Looper中会进入while循环，每次取出一个msg(<em>queue.next()</em>)，然后调用dispatchMessage()，在里面会有下面这段代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (msg.callback != null) {
</span><span class='line'>    msg.callback.run();
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>    ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>也就是说如果是post传进来的RunConnection对象的msg的话将会直接运行它的run函数，否则会直接调用handleMessage()进行处理。</p>

<hr />

<p>android的message机制其实就是一种异步消息处理机制，进程通过Handler的sendMessage或post将msg进行enqueueMessage，然后通过该线程自己的Looper进行消息队列轮询并根据相应的情况进行handle。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/05/android-service-startup/">Android Service Startup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-05T10:25:00+08:00" pubdate data-updated="true">Oct 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>现在要写一个service，在启动之后开启socket监听，等待用户端发消息给它进行处理。而这个service是不会有Activity的，于是乎就要考虑如何让这个service启动起来。</p>

<h4>System Service Startup</h4>

<p>最早想的是将这个service写成system service，然后通过SystemServer启动，这样是可行的，也蛮方便，具体的做法是这样的：</p>

<p>在framework/base/core/java/android/os/app/目录中写一个NewService类extends Service，之后在SystemServer.java中添加</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;New Service&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;newservice&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">NewService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Failure starting New Service&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>之后NewService就会开机启动，但是这样有一个问题，就是这个NewService的pid也就是SystemServer的pid，它们是处于同一个进程中的。于是由于种种原因我不希望启动一个系统服务，而是一个application level的service，这样就遇到一个问题：如果是一个单纯的没有activity的service应用，在通过<em>adb install</em>进系统后并不会自动启动，而是需要其它进程通过<em>startService()</em>或者<em>bindService()</em>启动，那么有没有什么其它方法让一个service在每次install之后启动呢？</p>

<h4>App Level Service Startup upon Installe</h4>

<p>这里有两种方案：</p>

<ul>
<li>1 通过先启动一个Activity，然后<em>startService()</em>启动该service，之后在Activity中将自己finish掉；</li>
<li>2 在application中注册一个BroadcastReceiver，监听PackageManager的<em>android.intent.action.PACKAGE_ADDED</em>的intent-filter，然后在Receiver的onReceive()里面通过</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Intent</span> <span class="n">serviceIntent</span> <span class="o">=</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">NewService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">context</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">serviceIntent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>进行启动。</p>

<p>在我看来第二种方案更符合我的要求，因为这样我就可以不用每次点击一下某个Activity才能启动service，但是这也是我最先否决的方案，因为我在Stack Overflow里面看到好多个讨论这个问题的帖子，其中有一个回复是这么说的：</p>

<blockquote><p>all applications, upon installation, are placed in a &#8220;stopped&#8221; state. This is the same state that the application winds up in after the user force-stops the app from the Settings application. While in this &#8220;stopped&#8221; state, the application will not run for any reason, except by a manual launch of an activity. Notably, noBroadcastReceviers will be invoked, regardless of the event for which they have registered, until the user runs the app manually.</p></blockquote>


<p>也就是说任何app level的应用都不可能在没有得到用户同意的情况下自动启动（特别是在android3.1之后，它们在安装后被置于了“stopped”的状态，只有当用户点击了某个Activity的图标才能启动起来，service也只有通过某个启动的Activity或Service通过startService()或bindService()才能启动起来。</p>

<p>所以第二个方案不可行，下面我们来看第一个方案：</p>

<p>在第一个方案里面，当Activity通过startService()启动service之后，就通过finish()将自己退出。这个时候按照android的specification，通过startService()启动的service是不会退出的（通过bindService()启动的service会随着activity的退出而退出），为了确定这一点，可以通过Settings->Apps->Running Service来查看。</p>

<h5>startForeground()</h5>

<p>另外，为了防止你在background运行的service在low memory的时候被系统强制退出，可以通过startForeground()将该service定义在foreground中，而这个所谓的foreground就是我们平时看到的位于android上方的消息栏，里面可以设置该service需要显示的信息，以及时间间隔&#8230;具体可以参见<a href="http://ytliu.github.com" title="Service API">Service API</a>，这里有一个简单的示例：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Notification</span> <span class="n">note</span><span class="o">=</span><span class="k">new</span> <span class="n">Notification</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">stat_notify_chat</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Can you hear the music?&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span><span class='line'><span class="n">Intent</span> <span class="n">i</span><span class="o">=</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">FakePlayer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">i</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_CLEAR_TOP</span><span class="o">|</span>
</span><span class='line'>  <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_SINGLE_TOP</span><span class="o">);</span>
</span><span class='line'><span class="n">PendingIntent</span> <span class="n">pi</span><span class="o">=</span><span class="n">PendingIntent</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'><span class="n">note</span><span class="o">.</span><span class="na">setLatestEventInfo</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;Fake Player&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Now Playing: \&quot;Ummmm, Nothing\&quot;&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="n">pi</span><span class="o">);</span>
</span><span class='line'><span class="n">note</span><span class="o">.</span><span class="na">flags</span><span class="o">|=</span><span class="n">Notification</span><span class="o">.</span><span class="na">FLAG_NO_CLEAR</span><span class="o">;</span>
</span><span class='line'><span class="n">startForeground</span><span class="o">(</span><span class="mi">1337</span><span class="o">,</span> <span class="n">note</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>App Level Service Startup when Bootup</h4>

<p>这是一种理论中的方法，因为我也没尝试过，具体方法参见<a href="http://" title="service startup when bootup">this article</a>，大概的意思是在application的Android.manifest文件中添加一个user-permission和一个receiver的intent-filter：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;application</span> <span class="err">...</span><span class="nt">&gt;</span>
</span><span class='line'>    ......
</span><span class='line'>    <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;.MyReceiver &quot;</span><span class="na">android:enabled=</span><span class="s">&quot;true&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;false&quot;</span><span class="err">]]</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.BOOT_COMPLETED&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/receiver&gt;</span>
</span><span class='line'><span class="nt">&lt;/application&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在MyReceiver类里面的onReceive()函数中开启相应的service：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">MyReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Intent</span> <span class="n">serviceIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">NewService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="n">context</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">serviceIntent</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种方法看上去应该是可行的，但是问题是用户每次装你的应用都要让系统重启一遍，那还有谁会那么好心情去安装你的应用啊？</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/28/opennebula-setup-note/">Opennebula Setup Note</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-28T14:30:00+08:00" pubdate data-updated="true">Sep 28<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这几天搞opennebula这个项目，一个很大的感受就是对于environement setup一定要有详细的笔记，不然过了一段时间就什么也想不起来了，遇到和以前一样的问题也不懂该如何解决。实在浪费时间，于是就把它记下来。</p>

<h2>基本命令</h2>

<p>首先是opennebula里面的一些基本命令，这里以kvm为例：</p>

<h3>Cloud Infrastructure Setup</h3>

<p>On Cluster:</p>

<pre><code>$ onecluster create cluster01
</code></pre>

<p>On Host (kvm):</p>

<pre><code>$ onehost create host01 --im im_kvm --vm vmm_kvm --net dummy 
$ onecluster addhost cluster01 host01
</code></pre>

<p>System Datastore (for running VM, not needed in front end):</p>

<pre><code>mount a NFS directory to /var/lib/one/datastores/0 for each host, if you would like to perform live migration.
</code></pre>

<p>Filesystem Datastore (for regular storage), sample config file: &#8216;ds.conf&#8217;</p>

<pre><code>$ onedatastore create ds.conf 
$ onecluster adddatastore cluster01 ds01 
$ onedatastore update 100
</code></pre>

<p>add SAFE_DIRS=&#8221;/var/lib/one/datastores/&#8221;, mount actual datastore to /var/lib/one/datastores/<datastore_id></p>

<h3>Set up Virtual Resource</h3>

<p>Virtual Machine Image</p>

<pre><code>$ oneimage create img_debian.conf --datastore ds01
</code></pre>

<p>Virtual Network</p>

<pre><code>$ onevnet create net_lease.conf
</code></pre>

<p>Virtual Machine Template</p>

<pre><code>$ onetemplate create vm_debian.conf 
$ onetemplate instantiate vm_debian --name debian1
</code></pre>

<p>Virtual Machine</p>

<pre><code>$ onevm deploy debian1 brick4 
$ onevm suspend debian1 
$ onevm resume debian1 
$ onevm resubmit debian1 
$ onevm stop debian1 
$ onevm delete debian1
</code></pre>

<h3>qemu/kvm</h3>

<p>create image:</p>

<pre><code>$ /usr/local/kvm/bin/qemu-img create -f qcow2 &amp;lt;img_name&amp;gt; 10G
</code></pre>

<p>create image from base:</p>

<pre><code>$ /usr/local/kvm/bin/qemu-img create -f qcow2 -b &amp;lt;base_img_name&amp;gt; &amp;lt;img_name&amp;gt;
</code></pre>

<p>install os:</p>

<pre><code>$ sudo /usr/local/kvm/bin/qemu-system-x86_64 -k en-us -hda vdisk.img -cdrom /path/to/boot-media.iso 
</code></pre>

<p>run image:</p>

<pre><code>$ /usr/local/kvm/bin/qemu-system-x86_64 -k en-us -hda vdisk.img -m 512
</code></pre>

<h2>权限问题</h2>

<h3>ssh 权限</h3>

<p>需要把front的oneadmin用户的.ssh/id_rsa.pub拷贝到host的oneadmin用户的.ssh/authorized_keys里面</p>

<p>需要把host的oneadmin用户的.ssh/id_rsa.pub拷贝到front的oneadmin用户的.ssh/authorized_keys里面（optional）</p>

<h3>账户设置</h3>

<p>两边oneadmin账户的uid，gid一定要相同！</p>

<p>On front:</p>

<pre><code>$ id oneadmin
uid=1002(oneadmin) gid=1002(oneadmin) groups=1002(oneadmin)
</code></pre>

<p>On host:</p>

<pre><code>$ addgroup --gid 1002 oneadmin
$ useradd --uid 1002 -g oneadmin -d /var/lib/one oneadmin
</code></pre>

<p>另外在host端的oneadmin还需要有/var/lib/one目录下所有东西的所有权，同时，oneadmin还需要加入<strong>group kvm</strong>（否则无法启动kvm）</p>

<pre><code>$ usermod -a -G kvm oneadmin
</code></pre>

<p>另外，由于/usr/bin/kvm的权限是root:root，所以这个也可能引发错误，或者将其权限改为oneadmin，或者为oneadmin添加一个root用户组:</p>

<pre><code>$ usermod -a -G root oneadmin
</code></pre>

<h3>libvirt</h3>

<p>！！！！搞了我好久，一直莫名其妙地出一个错误：</p>

<pre><code>internal error process exited while connecting to monitor: kvm: -drive file=/var/lib/one//datastores/0,if=none,id=drive-ide0-0-0,format=raw: 
could not open disk image /var/lib/one//datastores/0: Permission denied
</code></pre>

<p>我直接用kvm打开那个镜像都没问题，然后看到一个帖子http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=673427，再加上http://opennebula.org/documentation:archives:rel3.4:kvmg看到这样一句：</p>

<pre><code>Qemu should be configured to not change file ownership. Modify /etc/libvirt/qemu.conf to include dynamic_ownership = 0. To be able 
to use the images copied by OpenNebula, change also the user and group under which the libvirtd is run to “oneadmin”.
</code></pre>

<p>然后去<strong>/etc/libvirt/qemu.conf</strong>把user改成oneadmin,group改成cloud（顺便说下oneadmin也加了一个cloud的group),瞬间就起起来了！</p>

<p>然后，我把oneimage换了一下，把</p>

<pre><code>NAME          = "debian_new"
PATH          = /var/lib/one/datastores/ubuntu.11-10.x86-64.20111013.qcow2
加了三行：
TYPE          = OS
PERSISTENT    = YES
DRIVER        = qcow2
</code></pre>

<p>然后就起来了。。。其实我也不知道为什么，可能.qcow2结尾的镜像就是要qcow2的driver才能起起来吧</p>

<hr />

<p>之后配host2的时候还会碰到一个问题就是/var/run/libvirt/libvirt-sock和/var/tmp/one目录下的permission denied，对于前者，给oneadmin再加一个libvirtd的group，对于后者，把/var/tmp/one chown一下就好了</p>

<h2>NFS</h2>

<h3>On front</h3>

<pre><code>$ vi /etc/hosts
203.95.3.3 host1
203.95.3.4 host2

$ vi /etc/exports
/var/lib/one/datastores/0       host1(rw,no_root_squash)   #0是system datastore的编号，是opennebula自带的
/var/lib/one/datastores/104     host1(rw,no_root_squash)   #104是file system datastore的编号，由onedatastore自动创建的
</code></pre>

<h3>On host</h3>

<pre><code>$ cd
$ mkdir datasdores
$ mkdir datastores/0
$ mkdir datastores/104
$ sudo mount 203.95.3.5:/var/lib/one/datastores/104 /var/lib/one/datastores/104
$ sudo mount 203.95.3.5:/var/lib/one/datastores/0 /var/lib/one/datastores/0
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/21/progit-reading-2/">Progit Reading 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-21T16:50:00+08:00" pubdate data-updated="true">Sep 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>上章介绍了git internal的内容，接下里会从git更接近用户的角度来说。</p>

<hr />

<h1>git basic</h1>

<p>git中的文件有以下几种状态，而所有的命令也就是对于这几种状态的查看和转换：</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-4.png" title="git file status" alt="git file status" /></p>

<p>一般情况下，在新建一个文件后，需要<em>git add</em>将其变成tracked file，如果修改了一个该文件，则同样需要使用<em>git add</em>将其变成staged file，只有staged的文件才会在<em>git commit</em>的时候commit成功。</p>

<p><strong>git status</strong></p>

<p>这个可以用来查看当前文件的状态。如果我们在commit的参数中加上<em>-a</em>，就可以自动将tracked file变成staged file了。当然也可以忽略一些文件，这些都是写在.gitignore文件下的，那么，如何unstage一个文件呢？其实在你使用<em>git stage</em>命令的时候就会有提示:</p>

<pre><code>$ git reset HEAD &lt;file&gt;
</code></pre>

<p>同样的，我们也可以把一个modified file变成unmodified file:</p>

<pre><code>$ git checkout -- &lt;file&gt;
</code></pre>

<p><strong>git diff</strong></p>

<p>由于<em>git status</em>只能告诉我们哪些文件被修改了，而不能告诉我们都修改了哪些具体内容，所以有一个<em>git diff</em>命令来补充这个功能。</p>

<p><em>git diff</em>显示的是changed but not staged的文件，而<em>git diff &#8211;cached</em>显示的是staged的文件</p>

<p><strong>git commit</strong></p>

<p>这个就是将stage area里面的东西进行提交，在提交的时候需要指定<em>-m</em>参数。另外还有一个比较有用的命令叫*git commit &#8211;amend**用来返回到最近的一次commit之前，然后加一些其它文件，然后再自动提交一遍，这样就不会有两个相似的commit了。</p>

<p><strong>git rm</strong></p>

<p>如果只是简单地用<em>rm</em>命令，那么它还是处于unstage的状态，用<em>git rm</em>会将其变成untrack状态。另外，如果你加了参数<em>-f</em>则可以将其从index中删除，这样如果之前没有commit这个文件的话之后也就无法恢复了。</p>

<p>还有一个比较有用的命令是:</p>

<pre><code>$ git rm --cached &lt;file&gt;
</code></pre>

<p>这个命令可以在硬盘上保留file，但是将其从working tree中删除。比如说你忘记把file添加到.gitignore文件中的话就可以用这个命令。</p>

<p>同样，这个命令也支持正则表达式。</p>

<p><strong>git mv</strong></p>

<p>在git中，如果你用<em>git mv</em>命令，在git history中应该是没有renaming这个记录的，那么为什么还有mv这个命令呢？在git中：<em>git mv file_from file_to</em>这一个命令相当于</p>

<pre><code>$ mv file_from file_to
$ git rm file_from
$ git add file_to
</code></pre>

<p>这三条命令。</p>

<p><strong>git log</strong></p>

<p>用来查看git commit history，有许多有用的参数，比如<em>&#8211;stat</em>可以查看一些简略的信息，<em>-p -2</em>可以列出最近的两条entris，<em>&#8211;pretty=oneline</em>可以将history简略成一行，同样可以指定format——<em>&#8211;pretty=format:&#8221;%h - %an, %ar : %s</em>，而这些参数的意义如下:</p>

<pre><code>Option  Description of Output
%H  Commit hash
%h  Abbreviated commit hash
%T  Tree hash
%t  Abbreviated tree hash
%P  Parent hashes
%p  Abbreviated parent hashes
%an  Author name
%ae  Author e-mail
%ad  Author date (format respects the –date= option)
%ar  Author date, relative
%cn  Committer name
%ce  Committer email
%cd  Committer date
%cr  Committer date, relative
%s  Subject
</code></pre>

<p>另外还有<em>&#8211;graph</em>用来列出一个history graph，还有一些和时间相关的log，比如<em>&#8211;since=2.weeks</em>，列出两周内的commit信息&#8230;</p>

<pre><code>Option  Description
-(n)  Show only the last n commits
--since, --after  Limit the commits to those made after the specified date.
--until, --before  Limit the commits to those made before the specified date.
--author  Only show commits in which the author entry matches the specified string.
--committer  Only show commits in which the committer entry matches the specified strin
</code></pre>

<p><strong>git tag</strong></p>

<p>这个先不说了，感觉用不太到&#8230;</p>

<p><strong>git remote</strong></p>

<p>主要就7个命令：</p>

<pre><code>$ git remote add local_name url
$ git remote -v
$ git remote show local_name
$ git fetch [local_name | url]
$ git push [local_name | url] [branch_name]
$ git remote rename old_name new_name
$ git remote rm local_name
</code></pre>

<p><strong>tips and tricks</strong></p>

<p><em>git aliases</em>: 可以将很多命令缩写，比如:</p>

<pre><code>$ git config --global alias.co checkout
......
$ git config --global alias.unstage 'reset HEAD --'
$ git config --global alias.last 'log -1 HEAD'
</code></pre>

<h1>git branch</h1>

<p>git branch的抽象是这样子的，每次commit都会产生一个commit object:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-5.png" title="commit object" alt="commit object" /></p>

<p>而一个branch则有一个个commit object通过pointer串起来的:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-6.png" title="branch" alt="branch" /></p>

<p>在整个git目录中有一个很特别的index叫做HEAD，它指向了当前的branch:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-7.png" title="current branch" alt="current branch" /></p>

<p>之后，就是对branch的一些操作:</p>

<pre><code>$ git checkout -b new_branch
</code></pre>

<p>这个等价于:</p>

<pre><code>$ git branch new_branch
$ git checkout new_branch
</code></pre>

<p><strong>merge</strong></p>

<p>merge需要先指定base的branch，然后再和一个新的branch进行合并：</p>

<pre><code>$ git checkout base_branch
$ git merge another_branch
</code></pre>

<p>如果两个branch不在一个history中(如图所示):</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-8.png" title="merge branch 1" alt="merge branch 1" /></p>

<p>则会找到一个common ancestor，之后创建一个新的commit object，它的parents为两个branch，</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-9.png" title="merge branch 2" alt="merge branch 2" /></p>

<p>如果两个branch有conflic，则需要通过diff工具进行merge，merge完之后用<em>git add</em>和<em>git commit</em>进行确认。</p>

<p><strong>delete branch</strong></p>

<p>删除一个branch的命令为:</p>

<pre><code>$ git branch -d branch_name
</code></pre>

<p><strong>remote branch</strong></p>

<p>主要是个命令的使用:</p>

<pre><code>$ git clone url
$ git fetch local_name
$ git push local_name branch_name
$ git checkout --track local_name/branch_name   # set up a tracking branch
$ git checkout -b new_branch_name local_name/branch_name
$ git push local_name :branch_name  # delete a remote branch from the server
</code></pre>

<p><strong>rebasing</strong></p>

<p>和merge不同，rebase是将一个branch的改动replay到另一个branch上，比如说，一个简单的例子:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-10.png" title="rebase branch 1" alt="rebase branch 1" /></p>

<p>以experiment为current branch，<em>git merge master</em>的结果是这样的:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-11.png" title="rebase branch 2" alt="rebase branch 2" /></p>

<p>而以experiment为current branch，<em>git rebase master</em>的结果是这样的:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-12.png" title="rebase branch 3" alt="rebase branch 3" /></p>

<p>它的过程是这样的：先找到一个common ancestor，将两个branch的diff结果保存到一个文件里面，将当前的branch重新设成新的branch，之后将这些diff都应用到这个branch中。</p>

<p>对于rebase，有一点要注意的:</p>

<blockquote><p>Do not rebase commits that you have pushed to a public repository.</p></blockquote>


<p>否则会造成很多你意想不到的结果。</p>

<h1>git distribution</h1>

<p>/<em> fix me </em>/</p>

<h1>git tools</h1>

<p><strong>revision selection</strong></p>

<p>主要是几条命令:</p>

<pre><code>$ git log --abbrev-commit --pretty=oneline
$ git rev-parse topic1 
ca82a6dff817ec66f44342007202690a93763949
$ git reflog
$ git log -g branch     # see reflog of master
$ git show HEAD^    # see the parent commit of HEAD
$ git show HEAD~2   # see the grandparent commit of HEAD...
</code></pre>

<p>另外也可以看commit range，比如如图所示:</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-13.png" title="commit range" alt="commit range" /></p>

<p>branch1..branch2的意思是: all commits reachable by branch2 that aren&#8217;t reachable by branch1。</p>

<p>branch1&#8230;branch2的意思是: all commits that are reachable by either of two references but not by both of them。</p>

<p>所以:</p>

<pre><code>$ git log master..experiment
D 
C

$ git log experiment..master
F
E

$ git log master...experiment
F
E
D
C
</code></pre>

<p>另外下面三个命令是等价的:</p>

<pre><code>$ git log refA..refB
$ git log ^refA refB
$ git log refB --not refA
</code></pre>

<p><strong>interactive staging</strong></p>

<p>如果为<em>git add</em>加一个<em>-i</em>选项，则可以进入interactive的模式，之后会有几个命令让你选择:</p>

<pre><code>Commands * 1: status 2: update 3: revert 4: add untracked 5: patch 6: diff 7: quit 8: help 
</code></pre>

<p>之后就可以交互式地stage每个文件，同时，还可以stage文件的一部分（5：patch），很方便。</p>

<p><strong>stashing</strong></p>

<p>stashing的作用是将当前目录的状态（不管是modified还是staged的文件）都保存起来，然后做其它的工作，在之后可以从中恢复过来。</p>

<p>另外，可以用<em>git stash list</em>列出当前被stash的内容，之后用<em>git stash apply</em>来应用某个，或者<em>git stash drop</em>来丢弃某个，或者直接用<em>git stash pop</em>将最近的一个apply然后drop。</p>

<p>还有一种比较牛逼但比较用不到的场景，你apply了一个stash，do some work，然后想unapply之前的工作（指originally come from the stash），可以用这个命令:</p>

<pre><code>$ git stash show -p stash@{0} | git apply -R
</code></pre>

<p><strong>rewriting history</strong></p>

<p>之前有说过<em>git commit &#8211;amend</em>，这里要注意的是这个命令就像一个小的rebase，如果你已经push到remote的话最后就不要用这条命令了。</p>

<p>如果你想要改之前的commit，那么就需要用<em>git rebase</em>了，加上<em>-i</em>选项:</p>

<pre><code>$ git rebase -i HEAD~3
</code></pre>

<p>之后会有几个选项让你选:</p>

<pre><code>p, pick = use commit
r, reword = use commit, but edit the commit message
e, edit = use commit, but stop for amending
s, squash = use commit, but meld into previous commit
f, fixup = like "squash", but discard this commit's log message
x, exec = run command (the rest of the line) using shell
</code></pre>

<p>这里我遇到一个问题: 在退出编辑器的时候报错——could not execute editor，解决的办法是:</p>

<pre><code>$ git config --global core.editor "/usr/bin/vim"
</code></pre>

<p>总的来说这是一个很强大的功能，可以修改commit message，可以reordering commit，可以squashing commit，也可以splitting commit，还有一个非常牛逼的filter-branch功能，可以用来把一个文件从每次的commit中删除。在这里就不详细介绍了。</p>

<p><strong>debugging with git</strong></p>

<p>/<em> fix me </em>/</p>

<p><strong>submodules</strong></p>

<p>submodule的作用是将某段代码目录作为子目录导入你的主工程中，让别人可以下载，另外，由于这个子工程可能是别人开发的，所以需要分开来commit。</p>

<p>可以通过以下命令来建立submodule:</p>

<pre><code>$ git submodule add url local_module_name
</code></pre>

<p>但是如果你直接用<em>git clone</em>是不会把这个submodule下下来的，需要运行以下两个命令:</p>

<pre><code>$ git submodule init
$ git submodule update
</code></pre>

<p><strong>subtree merging</strong></p>

<p>/<em> fix me </em>/</p>

<h1>git customization</h1>

<p><strong>git configuration</strong></p>

<p>一般，git的配置参数在/etc/gitconfig和~/.gitconfig两个文件里面。</p>

<p>git可以设置默认的commit message:</p>

<pre><code>$ git config --global commit.template &lt;file&gt;
</code></pre>

<p>还有其它的:</p>

<pre><code>$ git config --global core.pager [more | less | '']
$ git config --global help.autocorrect [0 | 1]
$ git config --global color.ui [true | false]
$ git config --global color.branch [true | false | always]
$ git config --global color.diff [true | false | always]
......
</code></pre>

<p><strong>git attributes</strong></p>

<p>可以在.gitattributes中加入<em><em>.b binary</em>来表示以b结尾的文件都是binary file，这样在</em>git diff<em>的时候就不会diff它了，还可以通过</em>*.doc diff=word*来表示用word来进行diff，而word可以通过:</p>

<pre><code>$ git config diff.word.textconv strings
</code></pre>

<p>来进行设置。</p>

<p><strong>git hooks</strong></p>

<p>这是一个很强大的工具，你可以将所有可执行脚本通过合法的命名方式放在.git/hooks目录下，主要分为client-side和server-side的hooks，比如在client-side中，可以规定在commit之前运行一个脚本进行检查&#8230;</p>

<p>这是一个蛮有趣的话题，我会单独写一篇文章来说明下~</p>

<hr />

<p>以上基本上就是progit的全部内容，还有一些我觉得暂时还用不到就没有详细写，有一些我可能还会再单独更详细地描述。</p>

<p>总之，git真的是一个很神奇的用于提高开发效率和可靠性的工具，如果能熟练地掌握它的用法将能极大地提高工作效率。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/16/progit-reading-1/">Progit Reading 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-16T22:54:00+08:00" pubdate data-updated="true">Sep 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>花了大概两周的时间吧，把《progit》那本书看完了（我看书实在是比较慢，特别是这种英文书）。发觉git实在是一个太强大的工具了，以至于我看完了一遍又把前面所说的功能忘记了。。。orz。。。于是乎决定花一周时间重新回顾一下，顺便把一些牛逼的地方记下来。</p>

<h2>Plumbing &amp; Porcelain</h2>

<p>因为这是progit的最后一章，也是我刚刚看完的一章，还比较有印象。更重要的是这是git的internal的机制，对于深入理解git有很大的帮助，所以想先把这章啃下来。</p>

<p>porcelain是瓷器的意思，在这里是指git中比较user-friendly的命令，比如文中介绍的将近30条git命令，包括checkout, brance, commit, 以及所有的remote命令等等。而plumbing是水管的意思，和porcelain相对的，指的是一些和unix style类似的low-level的可以直接在脚本中执行的命令（其实我也没搞懂为什么要交porcelain和plumbing两个名字，感觉没什么关系啊？）。事实上，如果我没有理解错的话，porcelain在git中应该就是由一系列plumbing命令组成的。比如git commit命令就是由一个叫做“git commit-tree”的plumbing命令完成的，至于什么是commit-tree，以及这个tree是怎么形成的，这个会再接下来慢慢解释。</p>

<p>首先来看下.git目录下都有些什么。</p>

<pre><code>$ ls .git
HEAD
config
description
hooks/
index
info/
objects/
refs/
</code></pre>

<p>这些是在<em>git init</em>的时候初始化就默认产生的，其中description现在还不需要考虑，config主要用来配置一些program-specific的参数选项，info是一个目录，包含了一些需要被ignore的文件模式，而hooks定义了一些client或server端用于用户进行脚本定制的功能，这会在接下来详细介绍。而在这一节中主要描述了以下四个对象：<strong>HEAD</strong>，<strong>index</strong>，<strong>objects</strong>，<strong>refs</strong>。这是git最internal的部分。</p>

<h2>git objects</h2>

<p>object主要由两种组成：<em>tree object</em>和<em>commit object</em>，在介绍这两个object之前首先要说明下git的文件系统，git是一个content-addressable文件系统，换句话来说，对于git的核心存储来说仅仅是一个key-value数据库，你能向里面插入任何数据，并得到一个相对应的hash值用于之后的访问。这里有两个plumbing命令<em>hash-object</em>和<em>cat-file</em>，比如在新建的git仓库中输入以下命令；</p>

<pre><code>$ echo 'test content' | git hash-object -w --stdin
</code></pre>

<p><strong>-w</strong>表示对该object进行存储，将会返回：</p>

<pre><code>d670460b4b4aece5915caf5c68d12f560a9fe3e4
</code></pre>

<p>这个时候你查看.git/objects目录下的内容将会看到：</p>

<pre><code>$ find .git/objects -type f
  .git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4
</code></pre>

<p>其中d6是这个hash值的前两个数字，如果运行<em>cat-file</em>将会得到该object：</p>

<pre><code>$ git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4
  test content
</code></pre>

<p><strong>-p</strong>表示把里面的内容打印出来，而另一个参数<strong>-t</strong>这是将该object的类型打印出来：</p>

<pre><code>$ git cat-file -t d670460b4b4aece5915caf5c68d12f560a9fe3e4
  blob
</code></pre>

<p>注意这里的<em>blob</em>是一种type，它是属于整个<em>tree object</em>的叶子节点的类型，而那些中间节点都可以叫做tree。于是现在就可以详细来说说<em>tree object</em>了：</p>

<h3>tree object</h3>

<p>首先我们来运行以下的命令：</p>

<pre><code>$ vi test1
$ vi test2
$ find .git/objects/ -type f
$ git add .
$ find .git/objects/ -type f
  .git/objects//18/0cf8328022becee9aaa2577a8f84ea2b9f3827
  .git/objects//9f/71d140ff7712ec3a6dda42c09078fd290a3a61
$ git ci -m "first commit"
$ find .git/objects/ -type f
  .git/objects//18/0cf8328022becee9aaa2577a8f84ea2b9f3827
  .git/objects//92/bfc1480834507340a9bb30ac05fb4965785875
  .git/objects//9f/71d140ff7712ec3a6dda42c09078fd290a3a61
  .git/objects//dc/7a09861107e178fa0016fb48300b569de5c64c
$ git cat-file -p 92bf
  tree dc7a09861107e178fa0016fb48300b569de5c64c
  author ytliu &lt;mctrain016@gmail.com&gt; 1347865347 +0800
  committer ytliu &lt;mctrain016@gmail.com&gt; 1347865347 +0800

  first commit
$ git cat-file -p dc7a
  100644 blob 9f71d140ff7712ec3a6dda42c09078fd290a3a61 test1
  100644 blob 180cf8328022becee9aaa2577a8f84ea2b9f3827 test2
$ git cat-file -t dc7a
  tree
</code></pre>

<p>到目前为止，在first commit之后，整个数据存储的树结构是这样的：</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-1.png" title="tree object 1" alt="tree object 1" /></p>

<p>记下来我们新建一个目录dir，并再次commit一次：</p>

<pre><code>$ mkdir dir
$ vi dir/test3
$ git add .                 
$ find .git/objects/ -type f
  .git/objects//18/0cf8328022becee9aaa2577a8f84ea2b9f3827
  .git/objects//92/bfc1480834507340a9bb30ac05fb4965785875
  .git/objects//9f/71d140ff7712ec3a6dda42c09078fd290a3a61
  .git/objects//dc/7a09861107e178fa0016fb48300b569de5c64c
  .git/objects//df/6b0d2bcc76e6ec0fca20c227104a4f28bac41b
$ git ci -m "second commit" 
$ find .git/objects/ -type f
  .git/objects//18/0cf8328022becee9aaa2577a8f84ea2b9f3827
  .git/objects//41/77687db29c641515b10f13536dd70fae4ed142
  .git/objects//84/ddd13670be5f3636586915421cd98035ad9c66
  .git/objects//92/bfc1480834507340a9bb30ac05fb4965785875
  .git/objects//9f/71d140ff7712ec3a6dda42c09078fd290a3a61
  .git/objects//c5/04b82867a9a4104974edd54c56f01856d9426b
  .git/objects//dc/7a09861107e178fa0016fb48300b569de5c64c
  .git/objects//df/6b0d2bcc76e6ec0fca20c227104a4f28bac41b
$ git cat-file -t 4177      
  tree
$ git cat-file -p 4177
  040000 tree c504b82867a9a4104974edd54c56f01856d9426b dir
  100644 blob 9f71d140ff7712ec3a6dda42c09078fd290a3a61 test1
  100644 blob 180cf8328022becee9aaa2577a8f84ea2b9f3827 test2
$ git cat-layoutfile -p 84dd
  tree 4177687db29c641515b10f13536dd70fae4ed142
  parent 92bfc1480834507340a9bb30ac05fb4965785875
  author ytliu &lt;mctrain016@gmail.com&gt; 1347865426 +0800
  committer ytliu &lt;mctrain016@gmail.com&gt; 1347865426 +0800

second commit
$ git cat-file -p c504
  100644 blob df6b0d2bcc76e6ec0fca20c227104a4f28bac41b test3
</code></pre>

<p>可以看出，现在多了两个<em>tree object</em>，当前的树结构是这样的：</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-2.png" title="tree object 2" alt="tree object1 2" /></p>

<p>也就是说在新建一个dir的时候会新建一个<em>tree object</em>，而它指向的是这个dir下的blob或其它tree，另外，在进行一次commit的时候也会新建一个<em>tree object</em>，其包含的内容是staging area里面的所有东西。另外，git也提供了和<em>tree object</em>相关的plumbing命令：<em>write-tree</em>和<em>read-tree</em>。<em>write-tree</em>用于新建一个tree，把staging area里面的object就涵盖进来，而<em>read-tree</em>则是将一个tree读入staging area，比如运行以下命令：</p>

<pre><code>$ git write-tree
  4177687db29c641515b10f13536dd70fae4ed142
$ git cat-file -p 4177
  040000 tree c504b82867a9a4104974edd54c56f01856d9426b dir
  100644 blob 9f71d140ff7712ec3a6dda42c09078fd290a3a61 test1
  100644 blob 180cf8328022becee9aaa2577a8f84ea2b9f3827 test2
$ git read-tree --prefix=bak 4177
$ git write-tree
  389a980f31bfb78f9bf7e41d85fb3a1736a54f8c
$ git cat-file -p 389a
  040000 tree 4177687db29c641515b10f13536dd70fae4ed142 bak
  040000 tree c504b82867a9a4104974edd54c56f01856d9426b dir
  100644 blob 9f71d140ff7712ec3a6dda42c09078fd290a3a61 test1
  100644 blob 180cf8328022becee9aaa2577a8f84ea2b9f3827 test2
$ ls                  
  dir test1 test2
</code></pre>

<p>可以看出<em>write-tree</em>新建了一个<em>tree object</em>，并通过read-tree被标为bak，成为另一个tree的subtree，但是我们通过<strong>ls</strong>并不能显示出来这个tree——bak。</p>

<h3>commit object</h3>

<p>在之前的cat-file命令中可以看到有另一类object</p>

<pre><code>$ git cat-file -p 84dd
  tree 4177687db29c641515b10f13536dd70fae4ed142
  parent 92bfc1480834507340a9bb30ac05fb4965785875
  author ytliu &lt;mctrain016@gmail.com&gt; 1347865426 +0800
  committer ytliu &lt;mctrain016@gmail.com&gt; 1347865426 +0800

  second commit
$ git cat-file -t 84dd
  commit
</code></pre>

<p>这就是一个<em>commit object</em>，是在每一次commit的时候产生的。可以看到，它所指向的<em>tree object</em>为4177，即：</p>

<pre><code>$ git cat-file -p 4177
  040000 tree c504b82867a9a4104974edd54c56f01856d9426b dir
  100644 blob 9f71d140ff7712ec3a6dda42c09078fd290a3a61 test1
  100644 blob 180cf8328022becee9aaa2577a8f84ea2b9f3827 test2
</code></pre>

<p>这个很好理解，当然了，相应与<em>write-tree</em>，同样也有一个<em>commit object</em>相关的plumbing命令：<em>commit-tree</em>，用法大概是这样的：</p>

<pre><code>$ echo 'first commit' | git commit-tree 4177
  d8c7554eb5ee1a0eca359f3d58b99529ac94529c
$ echo 'second commit' | git commit-tree 389a -p d8c7 
  fc45c76849a24fe3e6b98fec5f17194c0c5f52a3
......
</code></pre>

<p>具体的就不详说了，前面的echo是commit message，<strong>-p</strong>选项表示parent。这个时候如果你运行git log:</p>

<pre><code>$ git log
  commit 84ddd13670be5f3636586915421cd98035ad9c66
  Author: ytliu &lt;mctrain016@gmail.com&gt;
  Date:   Mon Sep 17 15:03:46 2012 +0800

  second commit

  commit 92bfc1480834507340a9bb30ac05fb4965785875
  Author: ytliu &lt;mctrain016@gmail.com&gt;
  Date:   Mon Sep 17 15:02:27 2012 +0800

  first commit
</code></pre>

<p>它只显示了之前commit的记录，那么新commit的third commit和fourth commit呢？原因很简单，因为我在commit-tree third commit的时候并没有指定<strong>-p</strong>，所以它并没有接着second commit下去，而是自己新开了一个：</p>

<pre><code>$ git log fc45
  commit fc45c76849a24fe3e6b98fec5f17194c0c5f52a3
  Author: ytliu &lt;mctrain016@gmail.com&gt;
  Date:   Mon Sep 17 16:20:10 2012 +0800

  fourth commit

  commit d8c7554eb5ee1a0eca359f3d58b99529ac94529c
  Author: ytliu &lt;mctrain016@gmail.com&gt;
  Date:   Mon Sep 17 16:18:13 2012 +0800

  third commit
</code></pre>

<p>当然，我也没有指定它们属于那个branch，所以它现在是属于一个没有被记录的detached HEAD状态，不属于任何一个branch。如果需要为它加一个branch，可以用：</p>

<pre><code>$ git co fc4f -b new_branch
</code></pre>

<p>到目前为止，整个git仓库的objects的关系可以用下图来表示：</p>

<p><img src="http://ytliu.github.com/images/2012-09-16-3.png" title="object 1" alt="object 1" /></p>

<h2>git references</h2>

<p>其实.git/refs的目的主要是为了更方便用户记忆object，而不用每次都用一个那么长的SHA-1，比如：</p>

<pre><code>$ cat .git/refs/heads/master 
  84ddd13670be5f3636586915421cd98035ad9c66
</code></pre>

<p>这个就是传说中的master是怎么被关联到最新的commit的。你可以用git提供的plumbing命令<em>update-ref</em>来更新不同的ref：</p>

<pre><code>$ git update-ref refs/heads/master fc45
</code></pre>

<p>这个时候master就指向fourth commit了。当然你也可以用这个命令新建ref：</p>

<pre><code>$ git update-ref refs/heads/test 84dd
$ git co test
$ git log
  commit 84ddd13670be5f3636586915421cd98035ad9c66
  Author: ytliu &lt;mctrain016@gmail.com&gt;
  Date:   Mon Sep 17 15:03:46 2012 +0800

  second commit

  commit 92bfc1480834507340a9bb30ac05fb4965785875
  Author: ytliu &lt;mctrain016@gmail.com&gt;
  Date:   Mon Sep 17 15:02:27 2012 +0800

  first commit
</code></pre>

<p>还有一种reference是remote <em>reference</em>，可以用remote add来添加：</p>

<pre><code>$ git remote add origin git@github.com:something.git
</code></pre>

<p>然后吧本地的master分支push上去。</p>

<pre><code>$ git push origin master
</code></pre>

<p>然后你就可以在refs/remotes/origin/master下看到当前最新的分支情况了~</p>

<h2>HEAD</h2>

<p>HEAD其实就是一个reference指向当前branch的引用：</p>

<pre><code>$ cat .git/HEAD
  ref: refs/heads/test
</code></pre>

<p>我们可以直接修改这个文件，也可以用git提供的命令<em>symbolic-ref</em>来修改：</p>

<pre><code>$ git symbolic-ref HEAD refs/heads/test
$ cat .git/HEAD
  ref: refs/heads/test
</code></pre>

<h2>packfiles</h2>

<p>接下来是一个很重要的概念——packfile。具体的场景是这样的：</p>

<p>假设我们有一个很大的文件largefile，它的hash是fb699e017d85f1f0d037f0417a7e17a449533ecc：</p>

<pre><code>$ git cat-file -s fb69
  132480
</code></pre>

<p><strong>-s</strong>表示object的大小，这个时候我们对其进行了一个小小的修改，并重新commit：</p>

<pre><code>$ echo "modify a little" &gt;&gt; largefile
$ git add largefile
$ git ci -m "modify largefile"
</code></pre>

<p>这个时候largefile的hash就变成了084d9fa99e4558d38cba7006e3b28f6c87a8fd86；</p>

<pre><code>$ git cat-file -s 084d
  132496
</code></pre>

<p>可以看出，在git里面存了两个基本差不多的largefile的object，这样是非常浪费空间的。其实git在disk上存的object是一种叫做<em>loose object</em>的格式，而在一段时间之后git会将这些<em>loose object</em>打包。当然这种情况一般会在两种情况下发生: 执行<em>git gc</em>命令，以及push到remote server：</p>

<pre><code>$ git gc
$ find .git/objects/ -type f
  .git/objects//1e/f02bee3de76100febdefb8c55bf99fcfbdf714
  .git/objects//45/699e25f45a743e08c0909ce1925641f9c03e2e
  .git/objects//info/packs
  .git/objects//pack/pack-4ba1c4a110a95c95d7fc1a33d0c5916bb4c10a34.idx
  .git/objects//pack/pack-4ba1c4a110a95c95d7fc1a33d0c5916bb4c10a34.pack
</code></pre>

<p>可以看到，现在只剩下5行了，若我们用plumbing命令verify-pack来查看的话可以看到：</p>

<pre><code>$ git verify-pack -v .git/objects/pack/pack-4ba1c4a110a95c95d7fc1a33d0c5916bb4c10a34.pack 
  eb5efdaed6e57b4356a6758e77c998f1efd009ed commit 221 151 12
  5a937dca309316f541a433e624868dfe5196c165 commit 218 150 163
  fc45c76849a24fe3e6b98fec5f17194c0c5f52a3 commit 218 149 313
  84ddd13670be5f3636586915421cd98035ad9c66 commit 218 149 462
  d8c7554eb5ee1a0eca359f3d58b99529ac94529c commit 43 53 611 1 84ddd13670be5f3636586915421cd98035ad9c66
  92bfc1480834507340a9bb30ac05fb4965785875 commit 169 119 664
  902c38d7fbadea10287a581b9c557fea63d8b00c tree   133 131 783
  c504b82867a9a4104974edd54c56f01856d9426b tree   33 44 914
  df6b0d2bcc76e6ec0fca20c227104a4f28bac41b blob   6 15 958
  084d9fa99e4558d38cba7006e3b28f6c87a8fd86 blob   132496 316 973
  9f71d140ff7712ec3a6dda42c09078fd290a3a61 blob   7 16 1289
  180cf8328022becee9aaa2577a8f84ea2b9f3827 blob   6 15 1305
  f5adadb9b7cf88c0aa57bc4c810d5c2a68d93c5c tree   133 131 1320
  fb699e017d85f1f0d037f0417a7e17a449533ecc blob   13 22 1451 1 084d9fa99e4558d38cba7006e3b28f6c87a8fd86
  389a980f31bfb78f9bf7e41d85fb3a1736a54f8c tree   126 126 1473
  4177687db29c641515b10f13536dd70fae4ed142 tree   96 98 1599
  dc7a09861107e178fa0016fb48300b569de5c64c tree   66 70 1697
  non delta: 15 objects
  chain length = 1: 2 objects
  .git/objects/pack/pack-4ba1c4a110a95c95d7fc1a33d0c5916bb4c10a34.pack: ok
</code></pre>

<p>原来第一个largefile的object fb69 现在指向了084d，而其大小也变成了13，而084d作为修改过的largefile，大小还是132496。另外，git还把其它的一些类似的object进行了pack，更充分地缩减了空间。</p>

<h2>refspec</h2>

<p>这个是和remote branch相关的，即当你运行了<em>git remote add</em>命令后，在.git/config下面会有一个诸如：</p>

<pre><code>[remote "origin"]
url = git@github.com:something.git
fetch = +refs/heads/*:refs/remotes/origin/*
</code></pre>

<p>的entry，其中origin是remote端在本地的reference，url是remote端的地址，fetch是你在执行fetch命令时的操作，格式为(+)src:dst，其中src是remote side的匹配模式，dst是local side的匹配模式，+为可选，表示即使不是fast-forward也要更新reference。当然你也可以在每次fetch的时候手动指定。另外对于push同样有这种模式，只需要在config中加上一个push行就行了。</p>

<h2>remove object</h2>

<p>最后一个想讲的是如何真正地删除一个object。比如你有一个很大的object，你用<em>git rm</em>把他删除了，但是你并没有真正地把它从怎个历史中删除，任何一个其他人要fetch你的git仓库，都会把这个很大的object也一起fetch过去。那么，要如何才能真正意义上地删除一个大的object呢？</p>

<p>/<em> fix me </em>/</p>

<hr />

<p>接下来我会从头开始回顾：<em>git basic</em>, <em>git branch</em>, <em>git distribution</em>, <em>git tools</em>, 以及<em>git customization</em>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/13/guan-yu-shou-ji-he-yun-de-xue-zhu-yan-jiu/">关于手机和云的学术研究</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-13T14:00:00+08:00" pubdate data-updated="true">Sep 13<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这两天看了两篇关于手机和云结合的文章，两篇的motivation不同，所以所用的方法也就自然不一样了。下面对这两篇进行分别的介绍：</p>

<p>第一篇叫《<em>CloneCloud: Elastic Execution between Mobile Device and Cloud</em>》</p>

<p>分开来说就是用了三种技术，application partitioning, thread migration, remote execution，主要是前面两个：</p>

<p><strong>application partitioning</strong>: 主要用了static和dynamic相结合的方式，先用static找出合法的可分割点，再用dynamic计算出cost model，然后得出最合适的分割方案，生成partition configuration，主要是要注意两点：</p>

<p>1.这些都是在offline做的，在程序实际运行的时候直接获得configuration，然后在migrate point的时候进行migrate。</p>

<p>2.按照作者的意思是不需要source code的，是通过分析二进制文件来得到合法的分割点，但需要重写二进制文件，加入一些annotation比如migrate point之类的。另外，合法的分割点作者提出了几个限制：</p>

<pre><code>a.首先，它必须是method entry and exit point，不能是core-system library，当然在method里面调用的core 
library是允许的;
b.Methods that access specific features of a machine motivationust be pinned to the machine, 比如说
location-based的调用或者camera这些没有被virtualized的服务都不能被分到远端，这也是我后面会详细说的；
c.Methods that share native state must be collocated andt the same machine.也就是说那些调用native 
code同时share了native state的方法也不能被migrate
d.Prevent nested migration.
</code></pre>

<p><strong>thread migrate</strong>: 在Dalvik VM执行到migrate point的时候，会有一个migrator thread将thread suspend住，并将当前的thread state打包，把它所需要的信息通过网络发给cloud端的clone。这里的state主要包括execution stack frames and relevant data objects in the process heap, and register contents at the migration point. Virtualized stack frames…在cloud端的clone接收到这些信息后会有一个migrator thread来将这些信息装入VM的内存中，并继续执行，当遇到reintegration的时候用同样的方式将该thread的state打包发回去，mobile端的thread继续执行~这些看起来很容易，但是有一个问题，因为每一个object都是通过内存地址进行reference的，在不同的platform中这些reference可能会不一样，这里作者用了一种叫做object mapping table的方式，用一张图（Figure 7）就可以很方便的说明：</p>

<p><img src="http://ytliu.github.com/images/2012-09-13.png" title="object mapping table example" alt="object mapping table example" /></p>

<p>另外，clonecloud系统是实现在AOS和Android x86 virtual machine上的，修改了大约8000行的Dalvik代码，用JChord工具进行static analysis，用Monsoon power monitor [Mon]测量了energy consumption来计算cost model，通过hprof(HPR)进行thread state的capture。最后evaluation就不细说了，据说提速20X，降低了20X的能耗，当然这个是怎么测的我也没细看。</p>

<p>最后来说说clonecloud的限制：</p>

<p>首先是之前提到的platform-pinned的调用不能migrate到远程，其实从合法partition的限制来看就可以发现要partition不是那么容易的，其实作者也提出：We consider this alternative a complementary point in the design space, and plan to pursue it in conjunction with thread granularity migration in the future.从这个角度来看和我们的remote-binder的motivation还是很像的。除了这一点，两地之间不能内存共享也是一个限制partition很重要的方面。另外，作者提到的perfunctory concurrency其实应该不是一个太大的问题，本来这段code就是顺序执行的。</p>

<p>其实关于application的partition问题并没有结束，作者的method力度的partition也没有证明就是最好的，这一块应该还有研究的余地</p>

<hr />

<p>另外一篇叫《<em>Paranoid Android: Versatile Protection for Smartphones</em>》</p>

<p>这又是一篇mobile和cloud结合的paper，和clonecloud不同的是它强调的是security，所以它使用的方法也就不是thread migration，而是replica。按照作者的说法，cloud端的emulator中有一个mobile端系统的replica，而它的做法这是控制那些所谓的non-deterministic的因素，按照作者的说法，只有某些system call和来自OS的signal。为了达到mobile和cloud端的synchronization，主要分为两部分，mobile端的record和cloud端的replay。</p>

<p><strong>Record</strong>：主要是在mobile端，为了减小trace数据的传输，这里有几个原则和方法来缩减trace的大小：</p>

<ul>
<li>1.Record only system calls that introduce non-layoutdeterminism. 对于比如创建socket，读文件，甚至是IPC的syscall都不需要记录，因为这些都是replica那里也可以直接做的；</li>
<li>2.Use a network proxy so that inbound data are not logged in the trace. 这样可以避免网络数据传到mobile再从mobile传到replica，减小mobile端的负担和trace的大小；</li>
<li>3.Compress data using three andlgorithms. 这个就没什么好说的，就是把trace进行加密，减小其大小。</li>
</ul>


<p>在mobile端，整个系统的启动过程是这样的：</p>

<ul>
<li>1.Android的init进程先启动一个tracer进程，打开一个FIFO，等待其它进程的连接;</li>
<li>2.之后在init启动其它进程的时候，先启动一个exec stub，它会把该进程的pid写入tracer的FIFO中，表示需要被trace，然后pause；</li>
<li>3.tracer对这个进程进行attach，然后恢复exec stub的运行，stub运行exec命令执行进程的binary。</li>
</ul>


<p>其实总的来说record还是一个比较好理解的过程，但是对于replay，我觉得这是这篇文章中完全忽略的一个部分，它只是说有很多之前的工作对record和replay进行了研究，但是竟然一点都没有说明在replica端是如何进行replay的，这也就使得我对它所说的synchronization的效果产生了极大的怀疑。</p>

<p>另外，文中所说的record和replay只是对system call进行了记录和重放，但是对于一个这么复杂的系统，当当记录这些真的够吗？特别是对于手机这种特殊的设备来说，用户输入大部分是触控事件，而这些在文中（不管是paper还是technical report）都没有详细提到。而关于进程间的IPC通讯，作者只是在谈到ioctl的时候简单的提到了一下binder机制，并且在最后说这些进程间的通讯都是不需要被记录的，再加上在最后的evaluation部分，作者只是对trace的大小，已经performance的overhead进行了简单的测试，并没有对它所实现的原型的可行性的分析，这就让我对它们所说的mobile的replica产生了极大的怀疑。另外还有最后一个问题就是调用mobile特定的服务，比如location, camera的服务等，这些文中都没有合理的解释。仅仅是一个system call的record和replay移植到手机上其实并不是一个很有说服力的研究。</p>

<p>不过在这篇paper中我学到一点，就是paranoid对trace的保护，这也是我一开始就有的一个疑问。既然attacker可以攻击你的手机，自然就可以伪造trace，而且它又可以知道存在你手机中的key，那么该如何对这个关键的trace进行保护呢？虽然我不知道tamper-evidency这个方法是否作者自己提出来的，但是确实很有意思：它用了一个secure storage，将trace和一个HMAC code存在这个storage中，而存的方法是：</p>

<pre><code>STORE(message + HMAC(key,message)) 
key′ = HASH(key) 
key = key′
</code></pre>

<p>也就是说每一次的key都是上一次的key做hash得来的，由于attacker只能知道当前的key是什么，而无法知道之前的key，所以它就无法伪造entry，只能对其进行删除操作，那么在cloud端的replica就能通过计算发现trace的历史记录的修改。而做到这一点唯一需要保护的就是初始化的时候key在mobile和replica中的安全传递，这可以在整个系统启动的时候就做好了。</p>

<p>除此之外我也想过用append-only memory的方法，这样也能防止attacker对trace的修改，不过由于自己没有实际做个这个方面的研究，也不清楚它在手机中是否有实现。</p>

<p>总的来说，这是一篇提出概念的文章，通过cloud来对mobile进行安全检测，作者说实现的prototype可能真的是一个prototype，我都不确定是否真的实现了replica，是否真的运行起来了。加上作者对replica端基本没有做出什么介绍，所以感觉还是比较不靠谱的。</p>

<hr />

<p>现在cloud和mobile相结合的概念提出的越来越多了，但真正运用到世纪生活中的还很少很少，一方面是很多东西还停留在research阶段，没有比较稳定的工程实现，另一方面就是关于流量的考虑，mobile和cloud的结合离不开稳定的网络给予保障，而这些在现在的实际生活中还不能很完美的实现。不过我相信在不久之后，这两个当前及其流行的设备一定能非常好的结合在一起，方便大家的生活，并为mobile提供非常强有力的能源，性能和安全保障的。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/12/qiao-bang-zhu-chuan-you-gan/">乔帮主传有感</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/06/base64bian-ma/">Base64编码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/30/qemu-study-for-android-emulator/">Qemu study for Android emulator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/20/ru-guo-ming-tian-shi-shi-jie-mo-ri/">如果明天是世界末日</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/15/dynamic-linker/">Dynamic Linker</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("microtrain016", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/microtrain016" class="twitter-follow-button" data-show-count="false">Follow @microtrain016</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/mctrain016@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Liu Yutao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
