
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mctrain's Blog</title>
  <meta name="author" content="Liu Yutao">

  
  <meta name="description" content="最近发现自己对Linux里面很多的系统调用都不清楚具体是在怎么回事儿，想要好好学习一下。 在IBM的developerWorks中发现一份它们整理的Linux系统调用列表，从进程控制，文件系统控制等八个方面列举了大部分常见的Linux系统调用： 进程控制 System Call &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ytliu.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mctrain's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mctrain's Blog</a></h1>
  
    <h2>Security, Virtualization, Network, as well as life moments</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="ytliu.cc@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ytliu.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/30/xi-tong-diao-yong-xue-xi-bi-ji-%28%5B%3F%5D-%29-linuxxi-tong-diao-yong-biao-%28zhuan-%29/">系统调用学习笔记（一） - Linux系统调用表（转）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-30T09:56:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近发现自己对Linux里面很多的系统调用都不清楚具体是在怎么回事儿，想要好好学习一下。</p>

<p>在IBM的<a href="https://www.ibm.com/developerworks/cn/">developerWorks</a>中发现一份它们整理的<a href="http://www.ibm.com/developerworks/cn/linux/kernel/syscall/part1/appendix.html">Linux系统调用列表</a>，从进程控制，文件系统控制等八个方面列举了大部分常见的Linux系统调用：</p>

<h2>进程控制</h2>

<table>
<thead>
<tr>
<th align="center">System Call             </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">fork                    </td>
<td align="left"> 创建一个新进程</td>
</tr>
<tr>
<td align="center">clone                   </td>
<td align="left"> 按指定条件创建子进程</td>
</tr>
<tr>
<td align="center">execve                  </td>
<td align="left"> 运行可执行文件</td>
</tr>
<tr>
<td align="center">exit                    </td>
<td align="left"> 中止进程</td>
</tr>
<tr>
<td align="center">_exit                   </td>
<td align="left"> 立即中止当前进程</td>
</tr>
<tr>
<td align="center">getdtablesize           </td>
<td align="left"> 进程所能打开的最大文件数</td>
</tr>
<tr>
<td align="center">getpgid                 </td>
<td align="left"> 获取指定进程组标识号</td>
</tr>
<tr>
<td align="center">setpgid                 </td>
<td align="left"> 设置指定进程组标志号</td>
</tr>
<tr>
<td align="center">getpgrp                 </td>
<td align="left"> 获取当前进程组标识号</td>
</tr>
<tr>
<td align="center">setpgrp                 </td>
<td align="left"> 设置当前进程组标志号</td>
</tr>
<tr>
<td align="center">getpid                  </td>
<td align="left"> 获取进程标识号</td>
</tr>
<tr>
<td align="center">getppid                 </td>
<td align="left"> 获取父进程标识号</td>
</tr>
<tr>
<td align="center">getpriority             </td>
<td align="left"> 获取调度优先级</td>
</tr>
<tr>
<td align="center">setpriority             </td>
<td align="left"> 设置调度优先级</td>
</tr>
<tr>
<td align="center">modify_ldt              </td>
<td align="left"> 读写进程的本地描述表</td>
</tr>
<tr>
<td align="center">nanosleep               </td>
<td align="left"> 使进程睡眠指定的时间</td>
</tr>
<tr>
<td align="center">nice                    </td>
<td align="left"> 改变分时进程的优先级</td>
</tr>
<tr>
<td align="center">pause                   </td>
<td align="left"> 挂起进程，等待信号</td>
</tr>
<tr>
<td align="center">personality             </td>
<td align="left"> 设置进程运行域</td>
</tr>
<tr>
<td align="center">prctl                   </td>
<td align="left"> 对进程进行特定操作</td>
</tr>
<tr>
<td align="center">ptrace                  </td>
<td align="left"> 进程跟踪</td>
</tr>
<tr>
<td align="center">sched_get_priority_max  </td>
<td align="left"> 取得静态优先级的上限</td>
</tr>
<tr>
<td align="center">sched_get_priority_min  </td>
<td align="left"> 取得静态优先级的下限</td>
</tr>
<tr>
<td align="center">sched_getparam          </td>
<td align="left"> 取得进程的调度参数</td>
</tr>
<tr>
<td align="center">sched_getscheduler      </td>
<td align="left"> 取得指定进程的调度策略</td>
</tr>
<tr>
<td align="center">sched_rr_get_interval   </td>
<td align="left"> 取得按RR算法调度的实时进程的时间片长度</td>
</tr>
<tr>
<td align="center">sched_setparam          </td>
<td align="left"> 设置进程的调度参数</td>
</tr>
<tr>
<td align="center">sched_setscheduler      </td>
<td align="left"> 设置指定进程的调度策略和参数</td>
</tr>
<tr>
<td align="center">sched_yield             </td>
<td align="left"> 进程主动让出处理器,并将自己等候调度队列队尾</td>
</tr>
<tr>
<td align="center">vfork                   </td>
<td align="left"> 创建一个子进程，以供执行新程序，常与execve等同时使用</td>
</tr>
<tr>
<td align="center">wait                    </td>
<td align="left"> 等待子进程终止</td>
</tr>
<tr>
<td align="center">wait3                   </td>
<td align="left"> 参见wait</td>
</tr>
<tr>
<td align="center">waitpid                 </td>
<td align="left"> 等待指定子进程终止</td>
</tr>
<tr>
<td align="center">wait4                   </td>
<td align="left"> 参见waitpid</td>
</tr>
<tr>
<td align="center">capget                  </td>
<td align="left"> 获取进程权限</td>
</tr>
<tr>
<td align="center">capset                  </td>
<td align="left"> 设置进程权限</td>
</tr>
<tr>
<td align="center">getsid                  </td>
<td align="left"> 获取会晤标识号</td>
</tr>
<tr>
<td align="center">setsid                  </td>
<td align="left"> 设置会晤标识号</td>
</tr>
</tbody>
</table>


<h2>文件系统控制</h2>

<h4>文件读写操作</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">fcntl         </td>
<td align="left"> 文件控制</td>
</tr>
<tr>
<td align="center">open          </td>
<td align="left"> 打开文件</td>
</tr>
<tr>
<td align="center">creat         </td>
<td align="left"> 创建新文件</td>
</tr>
<tr>
<td align="center">close         </td>
<td align="left"> 关闭文件描述字</td>
</tr>
<tr>
<td align="center">read          </td>
<td align="left"> 读文件</td>
</tr>
<tr>
<td align="center">write         </td>
<td align="left"> 写文件</td>
</tr>
<tr>
<td align="center">readv         </td>
<td align="left"> 从文件读入数据到缓冲数组中</td>
</tr>
<tr>
<td align="center">writev        </td>
<td align="left"> 将缓冲数组里的数据写入文件</td>
</tr>
<tr>
<td align="center">pread         </td>
<td align="left"> 对文件随机读</td>
</tr>
<tr>
<td align="center">pwrite        </td>
<td align="left"> 对文件随机写</td>
</tr>
<tr>
<td align="center">lseek         </td>
<td align="left"> 移动文件指针</td>
</tr>
<tr>
<td align="center">_llseek       </td>
<td align="left"> 在64位地址空间里移动文件指针</td>
</tr>
<tr>
<td align="center">dup           </td>
<td align="left"> 复制已打开的文件描述字</td>
</tr>
<tr>
<td align="center">dup2          </td>
<td align="left"> 按指定条件复制文件描述字</td>
</tr>
<tr>
<td align="center">flock         </td>
<td align="left"> 文件加/解锁</td>
</tr>
<tr>
<td align="center">poll          </td>
<td align="left"> I/O多路转换</td>
</tr>
<tr>
<td align="center">truncate      </td>
<td align="left"> 截断文件</td>
</tr>
<tr>
<td align="center">ftruncate     </td>
<td align="left"> 参见truncate</td>
</tr>
<tr>
<td align="center">umask         </td>
<td align="left"> 设置文件权限掩码</td>
</tr>
<tr>
<td align="center">fsync         </td>
<td align="left"> 把文件在内存中的部分写回磁盘</td>
</tr>
</tbody>
</table>


<h4>文件系统操作</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">access        </td>
<td align="left"> 确定文件的可存取性</td>
</tr>
<tr>
<td align="center">chdir         </td>
<td align="left"> 改变当前工作目录</td>
</tr>
<tr>
<td align="center">fchdir        </td>
<td align="left"> 参见chdir</td>
</tr>
<tr>
<td align="center">chmod         </td>
<td align="left"> 改变文件方式</td>
</tr>
<tr>
<td align="center">fchmod        </td>
<td align="left"> 参见chmod</td>
</tr>
<tr>
<td align="center">chown         </td>
<td align="left"> 改变文件的属主或用户组</td>
</tr>
<tr>
<td align="center">fchown        </td>
<td align="left"> 参见chown</td>
</tr>
<tr>
<td align="center">lchown        </td>
<td align="left"> 参见chown</td>
</tr>
<tr>
<td align="center">chroot        </td>
<td align="left"> 改变根目录</td>
</tr>
<tr>
<td align="center">stat          </td>
<td align="left"> 取文件状态信息</td>
</tr>
<tr>
<td align="center">lstat         </td>
<td align="left"> 参见stat</td>
</tr>
<tr>
<td align="center">fstat         </td>
<td align="left"> 参见stat</td>
</tr>
<tr>
<td align="center">statfs        </td>
<td align="left"> 取文件系统信息</td>
</tr>
<tr>
<td align="center">fstatfs       </td>
<td align="left"> 参见statfs</td>
</tr>
<tr>
<td align="center">readdir       </td>
<td align="left"> 读取目录项</td>
</tr>
<tr>
<td align="center">getdents      </td>
<td align="left"> 读取目录项</td>
</tr>
<tr>
<td align="center">mkdir         </td>
<td align="left"> 创建目录</td>
</tr>
<tr>
<td align="center">mknod         </td>
<td align="left"> 创建索引节点</td>
</tr>
<tr>
<td align="center">rmdir         </td>
<td align="left"> 删除目录</td>
</tr>
<tr>
<td align="center">rename        </td>
<td align="left"> 文件改名</td>
</tr>
<tr>
<td align="center">link          </td>
<td align="left"> 创建链接</td>
</tr>
<tr>
<td align="center">symlink       </td>
<td align="left"> 创建符号链接</td>
</tr>
<tr>
<td align="center">unlink        </td>
<td align="left"> 删除链接</td>
</tr>
<tr>
<td align="center">readlink      </td>
<td align="left"> 读符号链接的值</td>
</tr>
<tr>
<td align="center">mount         </td>
<td align="left"> 安装文件系统</td>
</tr>
<tr>
<td align="center">umount        </td>
<td align="left"> 卸下文件系统</td>
</tr>
<tr>
<td align="center">ustat         </td>
<td align="left"> 取文件系统信息</td>
</tr>
<tr>
<td align="center">utime         </td>
<td align="left"> 改变文件的访问修改时间</td>
</tr>
<tr>
<td align="center">utimes        </td>
<td align="left"> 参见utime</td>
</tr>
<tr>
<td align="center">quotactl      </td>
<td align="left"> 控制磁盘配额</td>
</tr>
</tbody>
</table>


<h2>系统控制</h2>

<table>
<thead>
<tr>
<th align="center">System Call         </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">ioctl               </td>
<td align="left"> I/O总控制函数</td>
</tr>
<tr>
<td align="center">_sysctl             </td>
<td align="left"> 读/写系统参数</td>
</tr>
<tr>
<td align="center">acct                </td>
<td align="left"> 启用或禁止进程记账</td>
</tr>
<tr>
<td align="center">getrlimit           </td>
<td align="left"> 获取系统资源上限</td>
</tr>
<tr>
<td align="center">setrlimit           </td>
<td align="left"> 设置系统资源上限</td>
</tr>
<tr>
<td align="center">getrusage           </td>
<td align="left"> 获取系统资源使用情况</td>
</tr>
<tr>
<td align="center">uselib              </td>
<td align="left"> 选择要使用的二进制函数库</td>
</tr>
<tr>
<td align="center">ioperm              </td>
<td align="left"> 设置端口I/O权限</td>
</tr>
<tr>
<td align="center">iopl                </td>
<td align="left"> 改变进程I/O权限级别</td>
</tr>
<tr>
<td align="center">outb                </td>
<td align="left"> 低级端口操作</td>
</tr>
<tr>
<td align="center">reboot              </td>
<td align="left"> 重新启动</td>
</tr>
<tr>
<td align="center">swapon              </td>
<td align="left"> 打开交换文件和设备</td>
</tr>
<tr>
<td align="center">swapoff             </td>
<td align="left"> 关闭交换文件和设备</td>
</tr>
<tr>
<td align="center">bdflush             </td>
<td align="left"> 控制bdflush守护进程</td>
</tr>
<tr>
<td align="center">sysfs               </td>
<td align="left"> 取核心支持的文件系统类型</td>
</tr>
<tr>
<td align="center">sysinfo             </td>
<td align="left"> 取得系统信息</td>
</tr>
<tr>
<td align="center">adjtimex            </td>
<td align="left"> 调整系统时钟</td>
</tr>
<tr>
<td align="center">alarm               </td>
<td align="left"> 设置进程的闹钟</td>
</tr>
<tr>
<td align="center">getitimer           </td>
<td align="left"> 获取计时器值</td>
</tr>
<tr>
<td align="center">setitimer           </td>
<td align="left"> 设置计时器值</td>
</tr>
<tr>
<td align="center">gettimeofday        </td>
<td align="left"> 取时间和时区</td>
</tr>
<tr>
<td align="center">settimeofday        </td>
<td align="left"> 设置时间和时区</td>
</tr>
<tr>
<td align="center">stime               </td>
<td align="left"> 设置系统日期和时间</td>
</tr>
<tr>
<td align="center">time                </td>
<td align="left"> 取得系统时间</td>
</tr>
<tr>
<td align="center">times               </td>
<td align="left"> 取进程运行时间</td>
</tr>
<tr>
<td align="center">uname               </td>
<td align="left"> 获取当前UNIX系统的名称、版本和主机等信息</td>
</tr>
<tr>
<td align="center">vhangup             </td>
<td align="left"> 挂起当前终端</td>
</tr>
<tr>
<td align="center">nfsservctl          </td>
<td align="left"> 对NFS守护进程进行控制</td>
</tr>
<tr>
<td align="center">vm86                </td>
<td align="left"> 进入模拟8086模式</td>
</tr>
<tr>
<td align="center">create_module       </td>
<td align="left"> 创建可装载的模块项</td>
</tr>
<tr>
<td align="center">delete_module       </td>
<td align="left"> 删除可装载的模块项</td>
</tr>
<tr>
<td align="center">init_module         </td>
<td align="left"> 初始化模块</td>
</tr>
<tr>
<td align="center">query_module        </td>
<td align="left"> 查询模块信息</td>
</tr>
<tr>
<td align="center">*get_kernel_syms    </td>
<td align="left"> 取得核心符号,已被query_module代替</td>
</tr>
</tbody>
</table>


<h2>内存管理</h2>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">brk           </td>
<td align="left"> 改变数据段空间的分配</td>
</tr>
<tr>
<td align="center">sbrk          </td>
<td align="left"> 参见brk</td>
</tr>
<tr>
<td align="center">mlock         </td>
<td align="left"> 内存页面加锁</td>
</tr>
<tr>
<td align="center">munlock       </td>
<td align="left"> 内存页面解锁</td>
</tr>
<tr>
<td align="center">mlockall      </td>
<td align="left"> 调用进程所有内存页面加锁</td>
</tr>
<tr>
<td align="center">munlockall    </td>
<td align="left"> 调用进程所有内存页面解锁</td>
</tr>
<tr>
<td align="center">mmap          </td>
<td align="left"> 映射虚拟内存页</td>
</tr>
<tr>
<td align="center">munmap        </td>
<td align="left"> 去除内存页映射</td>
</tr>
<tr>
<td align="center">mremap        </td>
<td align="left"> 重新映射虚拟内存地址</td>
</tr>
<tr>
<td align="center">msync         </td>
<td align="left"> 将映射内存中的数据写回磁盘</td>
</tr>
<tr>
<td align="center">mprotect      </td>
<td align="left"> 设置内存映像保护</td>
</tr>
<tr>
<td align="center">getpagesize   </td>
<td align="left"> 获取页面大小</td>
</tr>
<tr>
<td align="center">sync          </td>
<td align="left"> 将内存缓冲区数据写回硬盘</td>
</tr>
<tr>
<td align="center">cacheflush    </td>
<td align="left"> 将指定缓冲区中的内容写回磁盘</td>
</tr>
</tbody>
</table>


<h2>网络管理</h2>

<table>
<thead>
<tr>
<th align="center">System Call     </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">getdomainname   </td>
<td align="left"> 取域名</td>
</tr>
<tr>
<td align="center">setdomainname   </td>
<td align="left"> 设置域名</td>
</tr>
<tr>
<td align="center">gethostid       </td>
<td align="left"> 获取主机标识号</td>
</tr>
<tr>
<td align="center">sethostid       </td>
<td align="left"> 设置主机标识号</td>
</tr>
<tr>
<td align="center">gethostname     </td>
<td align="left"> 获取本主机名称</td>
</tr>
<tr>
<td align="center">sethostname     </td>
<td align="left"> 设置主机名称</td>
</tr>
</tbody>
</table>


<h2>Socket控制</h2>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">socketcall    </td>
<td align="left"> socket系统调用</td>
</tr>
<tr>
<td align="center">socket        </td>
<td align="left"> 建立socket</td>
</tr>
<tr>
<td align="center">bind          </td>
<td align="left"> 绑定socket到端口</td>
</tr>
<tr>
<td align="center">connect       </td>
<td align="left"> 连接远程主机</td>
</tr>
<tr>
<td align="center">accept        </td>
<td align="left"> 响应socket连接请求</td>
</tr>
<tr>
<td align="center">send          </td>
<td align="left"> 通过socket发送信息</td>
</tr>
<tr>
<td align="center">sendto        </td>
<td align="left"> 发送UDP信息</td>
</tr>
<tr>
<td align="center">sendmsg       </td>
<td align="left"> 参见send</td>
</tr>
<tr>
<td align="center">recv          </td>
<td align="left"> 通过socket接收信息</td>
</tr>
<tr>
<td align="center">recvfrom      </td>
<td align="left"> 接收UDP信息</td>
</tr>
<tr>
<td align="center">recvmsg       </td>
<td align="left"> 参见recv</td>
</tr>
<tr>
<td align="center">listen        </td>
<td align="left"> 监听socket端口</td>
</tr>
<tr>
<td align="center">select        </td>
<td align="left"> 对多路同步I/O进行轮询</td>
</tr>
<tr>
<td align="center">shutdown      </td>
<td align="left"> 关闭socket上的连接</td>
</tr>
<tr>
<td align="center">getsockname   </td>
<td align="left"> 取得本地socket名字</td>
</tr>
<tr>
<td align="center">getpeername   </td>
<td align="left"> 获取通信对方的socket名字</td>
</tr>
<tr>
<td align="center">getsockopt    </td>
<td align="left"> 取端口设置</td>
</tr>
<tr>
<td align="center">setsockopt    </td>
<td align="left"> 设置端口参数</td>
</tr>
<tr>
<td align="center">sendfile      </td>
<td align="left"> 在文件或端口间传输数据</td>
</tr>
<tr>
<td align="center">socketpair    </td>
<td align="left"> 创建一对已联接的无名socket</td>
</tr>
</tbody>
</table>


<h2>用户管理</h2>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">getuid        </td>
<td align="left"> 获取用户标识号</td>
</tr>
<tr>
<td align="center">setuid        </td>
<td align="left"> 设置用户标志号</td>
</tr>
<tr>
<td align="center">getgid        </td>
<td align="left"> 获取组标识号</td>
</tr>
<tr>
<td align="center">setgid        </td>
<td align="left"> 设置组标志号</td>
</tr>
<tr>
<td align="center">getegid       </td>
<td align="left"> 获取有效组标识号</td>
</tr>
<tr>
<td align="center">setegid       </td>
<td align="left"> 设置有效组标识号</td>
</tr>
<tr>
<td align="center">geteuid       </td>
<td align="left"> 获取有效用户标识号</td>
</tr>
<tr>
<td align="center">seteuid       </td>
<td align="left"> 设置有效用户标识号</td>
</tr>
<tr>
<td align="center">setregid      </td>
<td align="left"> 分别设置真实和有效的的组标识号</td>
</tr>
<tr>
<td align="center">setreuid      </td>
<td align="left"> 分别设置真实和有效的用户标识号</td>
</tr>
<tr>
<td align="center">getresgid     </td>
<td align="left"> 分别获取真实的,有效的和保存过的组标识号</td>
</tr>
<tr>
<td align="center">setresgid     </td>
<td align="left"> 分别设置真实的,有效的和保存过的组标识号</td>
</tr>
<tr>
<td align="center">getresuid     </td>
<td align="left"> 分别获取真实的,有效的和保存过的用户标识号</td>
</tr>
<tr>
<td align="center">setresuid     </td>
<td align="left"> 分别设置真实的,有效的和保存过的用户标识号</td>
</tr>
<tr>
<td align="center">setfsgid      </td>
<td align="left"> 设置文件系统检查时使用的组标识号</td>
</tr>
<tr>
<td align="center">setfsuid      </td>
<td align="left"> 设置文件系统检查时使用的用户标识号</td>
</tr>
<tr>
<td align="center">getgroups     </td>
<td align="left"> 获取后补组标志清单</td>
</tr>
<tr>
<td align="center">setgroups     </td>
<td align="left"> 设置后补组标志清单</td>
</tr>
</tbody>
</table>


<h2>进程间通信</h2>

<h4>信号</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">sigaction     </td>
<td align="left"> 设置对指定信号的处理方法</td>
</tr>
<tr>
<td align="center">sigprocmask   </td>
<td align="left"> 根据参数对信号集中的信号执行阻塞/解除阻塞等操作</td>
</tr>
<tr>
<td align="center">sigpending    </td>
<td align="left"> 为指定的被阻塞信号设置队列</td>
</tr>
<tr>
<td align="center">sigsuspend    </td>
<td align="left"> 挂起进程等待特定信号</td>
</tr>
<tr>
<td align="center">signal        </td>
<td align="left"> 参见signal</td>
</tr>
<tr>
<td align="center">kill          </td>
<td align="left"> 向进程或进程组发信号</td>
</tr>
<tr>
<td align="center">*sigblock     </td>
<td align="left"> 向被阻塞信号掩码中添加信号,已被sigprocmask代替</td>
</tr>
<tr>
<td align="center">*siggetmask   </td>
<td align="left"> 取得现有阻塞信号掩码,已被sigprocmask代替</td>
</tr>
<tr>
<td align="center">*sigsetmask   </td>
<td align="left"> 用给定信号掩码替换现有阻塞信号掩码,已被sigprocmask代替</td>
</tr>
<tr>
<td align="center">*sigmask      </td>
<td align="left"> 将给定的信号转化为掩码,已被sigprocmask代替</td>
</tr>
<tr>
<td align="center">*sigpause     </td>
<td align="left"> 作用同sigsuspend,已被sigsuspend代替</td>
</tr>
<tr>
<td align="center">sigvec        </td>
<td align="left"> 为兼容BSD而设的信号处理函数,作用类似sigaction</td>
</tr>
<tr>
<td align="center">ssetmask      </td>
<td align="left"> ANSI C的信号处理函数,作用类似sigaction</td>
</tr>
</tbody>
</table>


<h4>消息</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">msgctl        </td>
<td align="left"> 消息控制操作</td>
</tr>
<tr>
<td align="center">msgget        </td>
<td align="left"> 获取消息队列</td>
</tr>
<tr>
<td align="center">msgsnd        </td>
<td align="left"> 发消息</td>
</tr>
<tr>
<td align="center">msgrcv        </td>
<td align="left"> 取消息</td>
</tr>
</tbody>
</table>


<h4>管道</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">pipe          </td>
<td align="left"> 创建管道</td>
</tr>
</tbody>
</table>


<h4>信号量</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">semctl        </td>
<td align="left"> 信号量控制</td>
</tr>
<tr>
<td align="center">semget        </td>
<td align="left"> 获取一组信号量</td>
</tr>
<tr>
<td align="center">semop         </td>
<td align="left"> 信号量操作</td>
</tr>
</tbody>
</table>


<h4>共享内存</h4>

<table>
<thead>
<tr>
<th align="center">System Call   </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">shmctl        </td>
<td align="left"> 控制共享内存</td>
</tr>
<tr>
<td align="center">shmget        </td>
<td align="left"> 获取共享内存</td>
</tr>
<tr>
<td align="center">shmat         </td>
<td align="left"> 连接共享内存</td>
</tr>
<tr>
<td align="center">shmdt         </td>
<td align="left"> 拆卸共享内存</td>
</tr>
</tbody>
</table>


<p>后面会慢慢对其中的某些进行详细的学习。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/30/xi-tong-diao-yong-xue-xi-bi-ji-ptrace/">系统调用学习笔记 - Ptrace和wait</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-30T09:46:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在系统安全这门课上讲到ptrace这个系统调用，我马上想到当年做CFIMon里面用到的ptrace:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">child</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * force the task to stop before executing the first</span>
</span><span class='line'><span class="cm">     * user level instruction</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">......</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">execvp</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* not reached */</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在parent的代码里面：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * wait for the child to exec</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</span><span class='line'>        <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;task %s [%d] exited already status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pid</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">......</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">perf_event_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">map_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">......</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * effectively activate monitoring</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">......</span>
</span></code></pre></td></tr></table></div></figure>


<p>先是waitpid，等待child调用execv，之后设置一系列参数（在这里是打开perf_event，并mmap一段内存区域），然后调用ptrace让child继续执行。</p>

<p>其实到现在为止我也还不是很清楚ptrace的用法和waitpid那几个参数的意思，于是想好好学习下，在google上搜到了一篇翻译的<a href="http://www.kgdb.info/gdb/playing_with_ptrace_part_i/">玩转ptrace1</a>和<a href="http://www.kgdb.info/gdb/playing_with_ptrace_part_ii/">2</a>，这里归纳整理下，另外，在IBM的<a href="https://www.ibm.com/developerworks/cn/">developerWorks</a>上找到一篇介绍进程相关只是，以及waitpid的<a href="http://www.ibm.com/developerworks/cn/linux/kernel/syscall/part3/">博文</a>，也一起学习了。</p>

<hr />

<h3>僵尸进程和wait</h3>

<p>在linux中，当一个进程退出（如调用exit等）后，并不是马上完全消失掉了，它还会留下一些踪迹，成为一个僵尸进程（Zombie）。作为一个僵尸进程来说，它已经放弃了几乎所有内存空间，没有任何可执行代码，也不能被调度，仅仅在进程列表中保留一个位置，记载该进程的退出状态等信息供其他进程收集，除此之外，僵尸进程不再占有任何内存空间。在僵尸进程记录了这个进程是怎么死亡的（是正常退出呢，还是出现了错误，还是被其它进程强迫退出的？），以及它占用的总系统CPU时间和总用户CPU时间分别是多少？还有发生页错误的数目和收到信号的数目等。</p>

<p>而wait和waitpid这两个系统调用就是用来收集这些信息，并使得这个僵尸进程永远消失的。</p>

<p>这两个系统调用的原型是这样子的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="cp">#include &lt;sys/wait.h&gt;  </span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pid_t</span> <span class="n">wait</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pit_t</span> <span class="n">wait</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span><span class="kt">int</span> <span class="n">options</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于wait来说，它是等待所有的子进程的退出， 而对比来看，waitpid增加了两个参数<code>pid</code>和<code>option</code>。</p>

<p>对于pid来说，有四种情况：</p>

<table>
<thead>
<tr>
<th align="center">pid         </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">pid == -1   </td>
<td align="left"> 等待任一个子进程（与wait等效）；</td>
</tr>
<tr>
<td align="center">pid > 0     </td>
<td align="left"> 则等待其进程ID与pid相等的子进程。</td>
</tr>
<tr>
<td align="center">pid == 0    </td>
<td align="left"> 等待其组ID等于调用进程组ID的任一个子进程。</td>
</tr>
<tr>
<td align="center">pid &lt; -1    </td>
<td align="left"> 等待其组ID等于pid绝对值的任一子进程。</td>
</tr>
</tbody>
</table>


<p>另外，如果参数status的值不是NULL，wait就会把子进程退出时的状态取出并存入其中，这是一个整数值，指出了子进程是正常退出还是被非正常结束的，以及正常结束时的返回值，或被哪一个信号结束的等信息。有一套专门的宏（macro）来对其进行操作：</p>

<table>
<thead>
<tr>
<th align="center">macro               </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">WIFEXITED(status)   </td>
<td align="left"> 若子进程是正常退出的，则为真，此时可以调用WEXITSTATUS(status)获得退出值</td>
</tr>
<tr>
<td align="center">WEXITSTATUS(status) </td>
<td align="left"> 若子进程是被异常终止的，则为真，此时可以调用WTERMSIG(status)获得使其终止的信号编号</td>
</tr>
<tr>
<td align="center">WIFSTOPPED(status)  </td>
<td align="left"> 若子进程是暂停状态，则为真，此时可以调用WTERMSIG(status)获得使其暂停的信号编号</td>
</tr>
</tbody>
</table>


<p>到现在未知，还有一个参数叫option，它提供了一些额外的选项来控制waitpid，目前在Linux中只支持WNOHANG和WUNTRACED两个选项：</p>

<table>
<thead>
<tr>
<th align="center">option      </th>
<th align="left"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">WNOHANG     </td>
<td align="left"> waitpid在调用时发现没有已退出的子进程可收集，则返回0</td>
</tr>
<tr>
<td align="center">WUNTRACED   </td>
<td align="left"> 在所有符合条件的pid中，如果其中有已经stopped的进程，则立即返回（而对于traced的进程，即使没有该选项，如果其stopped了，也会立即返回）</td>
</tr>
</tbody>
</table>


<hr />

<h3>ptrace笔记</h3>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/14/tong-bu-yuan-yu-xue-xi-bi-ji-lock%2Crcuhe-transaction/">同步原语学习笔记 - Lock，RCU和Transaction Memory</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-14T14:24:00+08:00" pubdate data-updated="true">Apr 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这周最大的收获就是周四那天，感觉被洗脑了一样，上午P哥给我们讲他的<a href="http://ipads.se.sjtu.edu.cn/lib/exe/fetch.php?media=publications:reemu-ppopp13.pdf">ReEmu</a>，里面讲的最多的就是在它的replay系统中如何记录shared memory access order。还有一个就是Naruil下午讲的“The myth of lock &amp; scalability“，讲了lock，RCU，Transaction memory的一些基本原理和它们的发展过程，以及其中的一些scalability的问题。</p>

<p>关于ReEmu，主要是说需要记录哪些non-determinism：里面主要讲了interrupt，DMA handling，在不同cores发生page fault时的走页表顺序问题，对于一些non-deterministic的指令，比如in/out的处理，以及在共享内存访问中不同核的访问顺序。其中最重要的就是memory access order，即如何记录read-after-write, write-after-write和write-after-read的方法。这篇paper最大的贡献在于它利用了CREW（Concurrent Read，Exclusive Write）和seqlock的特性，利用version极大地减小了原子操作的数量，减小了log的大小，提高了efficiency和scalability。具体如何做的还是直接看paper吧，这里就不详述了。</p>

<p>这次主要想记的是Naruil关于一些同步原语的讲解。之前一直对Read-Write Lock, RCU，Transaction Memory等都只是一知半解，这几周由于海波和大爷的课，以及组会对这些都提到了好多，因此希望能把它们记下来做个笔记，省的自己又很快就忘记了。</p>

<p>slides在<a href="http://ipads.se.sjtu.edu.cn/courses/ads/slides/lec7-lock.pdf">这里</a>。</p>

<p>刚开始有个印象很深的提法，他说在计算机中不同核（或者在分布式系统中不同机器）之间的交流一般只有两种方式：<strong>message passing</strong>和<strong>shared memory</strong>，而对于第二种shared memory的方式，其本质上也是一种message passing（比如在多核之间的SM其实就是inter-processor间cache的message passing）。</p>

<p>还有一个印象很深的知识点就是对于我们平常提到的原子指令（比如test_and_set），只要是对于一个共享变量的原子指令，都会涉及到cache invalidation，即要把其它核的cache line都invalidate，这就是造成在多核环境下scalability上不去的原因，因为过多的原子指令将会造成in-flight的message太多（这个也是那篇<a href="http://pdos.csail.mit.edu/papers/linux:lock.pdf">Non-scalable locks are dangerous</a>强调的问题）。因此在同步原语中要想获得高的scalability，就必须减少对共享变量的原子操作（其实在ReEmu中它的目的也正是如此）。</p>

<h3>Read-Write Lock</h3>

<p>读写锁，顾名思义，就是将读锁和写锁分开来处理，对于读锁，它可以允许多个读者同时对一个共享变量进行读取，但是需要维护一个全局counter来记录读者的数量。当某个核产生一个写的请求，那么就不能再允许有新的读者进入critical section（CS），而写者也需要所有读者结束（即counter降为0）后才可以进入写的CS。在这里，一般的实现方式是这样的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Read</span> <span class="n">object</span> <span class="n">begin</span>
</span><span class='line'>  <span class="n">P</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
</span><span class='line'>  <span class="n">AtomicAdd</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">activeReader</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">V</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
</span><span class='line'>  <span class="n">Do</span> <span class="n">Actual</span> <span class="n">Read</span>
</span><span class='line'>  <span class="n">AtomicAdd</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">activeReaders</span><span class="p">,</span> <span class="err">−</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">end</span>
</span><span class='line'><span class="n">Write</span> <span class="n">object</span> <span class="n">begin</span>
</span><span class='line'>  <span class="n">P</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">object</span><span class="p">.</span><span class="n">activeReaders</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">do</span> <span class="n">delay</span>
</span><span class='line'>  <span class="n">Do</span> <span class="n">Actual</span> <span class="n">Write</span>
</span><span class='line'>  <span class="n">V</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
</span><span class='line'><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里值得注意的是，虽然它减小了读者和读者之间信号量（P/V）的竞争，但是读者在读之前需要对共享变量activeReader进行原子加，安装前面所说的，这就会造成cache line invalidate message数量的增加，不具有很好的可扩展性。</p>

<p>为了减小等待message的时间，有一种解决方法叫GOLL:</p>

<p><img src="http://ytliu.github.com/images/2013-04-14-01.png" title="GOLL" alt="GOLL" /></p>

<p>即构造一棵二叉树，两个reader共享一个activeReader，而对于writer来说，只要其子节点存在activeReader，则它就为1。</p>

<p>另外一种方法叫BR lock：</p>

<p><img src="http://ytliu.github.com/images/2013-04-14-02.png" title="big reader lock" alt="BRLock" /></p>

<p>和GOLL相比，它为每一个reader都维护一个变量，这样在reader之间都完全不会存在message，但是对于writer来说，它的overhead则增大了很多，在writer进入CS之前，需要所有的reader都发message给它。</p>

<p>另外，如果我们为了增加公平性，采用一个ticket lock的形式，那么同样的，如果这个ticket是全局共享的，那么也会有同样的问题，于是就提出了一种叫做MCS lock的机制。</p>

<h3>MCS Lock</h3>

<p>MCS是由两个人(Mellor-Crummey and Scott)发明的算法，相比于需要维护一个全局变量的ticket based lock，在MCS lock中，每个进程只需要各自维护一个local variable，这个局部变量可以是一个用于spin的flag，用于标识自己是否拿到锁了。另外，存在一个全局的队列，拿锁的过程相当于向队列中插入一个结构体qnode，这个结构体包含了某个进程的flag——locked，和这个qnode指向的下一个qnode的地址：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">procedure</span> <span class="n">acquire_lock</span><span class="p">(</span> <span class="n">L</span><span class="o">:</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="n">I</span><span class="o">:</span> <span class="o">*</span><span class="n">qnode</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">pred</span><span class="o">:</span> <span class="o">*</span><span class="n">qnode</span>
</span><span class='line'>  <span class="n">I</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:=</span> <span class="n">nil</span> <span class="c1">// Initially, no successor</span>
</span><span class='line'>  <span class="n">pred</span> <span class="o">:=</span> <span class="n">swap</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="c1">// Queue for lock</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">pred</span> <span class="mi">6</span><span class="o">=</span> <span class="n">nil</span> <span class="c1">// Lock was not free</span>
</span><span class='line'>      <span class="n">i</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">:=</span> <span class="nb">true</span> <span class="c1">// Prepare to spin</span>
</span><span class='line'>      <span class="n">pred</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:=</span> <span class="n">I</span> <span class="c1">// Link behind predecessor</span>
</span><span class='line'>      <span class="n">repeat</span> <span class="k">while</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="c1">// Busy wait for lock</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这里，有一个变量<code>L</code>，它也是一个qnode，表示全局队列中最后一个拿锁插入的qnode，通过<code>swap(L, I)</code>（将I的值赋给L，并返回L的值），得到前一个拿锁的qnode pred，将它的next指向自己，并spin在自己的这个locked局部变量中。</p>

<p>而释放锁的过程也就显而易见了：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">procedure</span> <span class="n">release_lock</span><span class="p">(</span> <span class="n">L</span><span class="o">:</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="n">I</span><span class="o">:</span> <span class="o">*</span><span class="n">qnode</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">nil</span> <span class="c1">// No known successor</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">compare_and_swap</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="c1">// No successor, lock free</span>
</span><span class='line'>      <span class="n">repeat</span> <span class="k">while</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">nil</span> <span class="c1">// Wait for successor</span>
</span><span class='line'>  <span class="n">I</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">:=</span> <span class="nb">false</span> <span class="c1">// Pass lock</span>
</span></code></pre></td></tr></table></div></figure>


<p>先判断自己是不是最后一个拿锁的人，如果不是，则将下一个qnode的locked设成false，即将锁传递给下一个qnode。</p>

<p>由于MCS lock是spin在自己的局部变量上的，所以就没有前面说过的scalability的问题。不过MCS对于核数比较少的情况似乎性能不是很好（这个我也不是很理解）。</p>

<h3>RCU (Read-Copy-Updata)</h3>

<p>除了lock之后，还有一种同步原语叫RCU：</p>

<p><img src="http://ytliu.github.com/images/2013-04-14-03.png" title="RCU" alt="RCU" /></p>

<p>RCU最大的特点在于writer可以在reader进行读取操作的时候直接修改，不过需要注意的是，这里的修改是这样的：</p>

<ul>
<li>首先对Shared_data进行一次拷贝（到一个新的地址B）；</li>
<li>更新B指向的对象；</li>
<li>将Shared_data原来的地址赋给一个新的变量Old_data；</li>
<li>将Shared_data赋值为B。</li>
</ul>


<p>这样有一个问题就是，几个reader可能会在一段时间内读到的值是不一样的，有些读到的是old value，有些读到的是new value。但是可以保证的是，当执行完</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Shared_data</span> <span class="o">=</span> <span class="n">B</span>
</span></code></pre></td></tr></table></div></figure>


<p>之后，所有的reader读到的值都是改过后的值！</p>

<p>另外这里还要考虑一个问题，那就是什么时候释放这个Old_data？</p>

<p>这里注意在Reader的代码中，<code>rcu_read_lock()</code>会关闭中断，禁止在一个核中其它进程的抢断，而<code>rcu_read_unlock()</code>则会打开中断，恢复抢断机制。于是writer就可以根据reader进程是否进行过context switch来判断说是否对Shared_data的读过程是否全部结束了：</p>

<p><img src="http://ytliu.github.com/images/2013-04-14-04.png" title="RCU Figure" alt="RCU figure 2" /></p>

<p>RCU还要考虑的一个问题是在reader中是否能允许sleep？因为如果一个reader在读的过程中如果碰到一段IO操作，那么它如果不sleep的话，则会很大地浪费CPU资源，而如果sleep的话，则会发生一次context switch，而此时，读的过程其实并没有结束，与RCU的语义就不符了。</p>

<p>对于这个问题，按照Naruil的说法，也产生了一系列研究，比如允许sleep的RCU等，这里就不展开了（其实是我也不懂啦）。</p>

<p>和之前提到的RW lock等相比，RCU没有scalability的问题，性能会好很多。所以当前RCU被运用到Linux的很多地方，这里有一个插曲是说当年发明RCU的是作者是IBM的一个员工，它就靠着RCU这么一个东西在IBM待了20多年，而RCU也被申请了专利，像FreeBSD这些系统是不被允许使用RCU的。</p>

<p>当然RCU还有很多问题，比如它有很多semantic的限制，对于那些不允许在一段时间内多个reader会读到不同值的情况就不能使用RCU。另外，RCU只能应用在一些比较简单的数据结构中，如果遇到比较复杂的数据结果就挂掉了，因为它需要程序员自己处理很多corner cases。</p>

<h3>Transaction Memory</h3>

<p>最后要讲的一个同步原语就是Transaction Memory（TM），这个最近几年很火的一个研究方向，特别是当Hardware TM（HTM）问世之后。</p>

<p>安装Naruil的说法，TM的原理大概是这样的：在一个Transaction中，可以访问不同的对象（这个粒度可以自己控制，可以是几个cache line，几个page&#8230;)，而当访问了某个对象之后，它对应的cache line上就会有一个flag标识，当一个进程进行commit，则会将自己对应的那些cache line上的flag清楚，而对于其它访问了这些cache line的transaction，则会abort，并invalidate 这些cache line。</p>

<p>TM的好处在于它可以非常细粒度地进行同步，并且避免了对lock这样一个额外的同步变量维护产生的cache message。</p>

<hr />

<p>同步原语真的是一个非常需要智商的领域，我最近对此感觉特别深刻。我想在这个领域里搞研究的应该都是一群智商超群的人吧:)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/09/netfilterxue-xi-bi-ji-%28san-%29/">Netfilter学习笔记（三）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-09T21:21:00+08:00" pubdate data-updated="true">Apr 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这次的内容主要是关于在Android上如何使用iptables。</p>

<p>其实在android源码中已经有对iptables进行了支持，如何确定可以参看<a href="http://www.roman10.net/how-to-build-and-use-libnetfilter_queue-for-android/">这里</a>。</p>

<p>这里简单说下如何采用nfqueue对其进行控制：</p>

<p>首先说下一个很简单的场景：我们需要将从手机端发到192.168.1.2服务器的所有TCP包都拦截下来，将包的信息打印出来，并将其发送出去。</p>

<p>具体的步骤如下：</p>

<ul>
<li><p>首先将手机连到PC上，运行：</p>

<p>  $ adb shell
  $ su
  #</p></li>
</ul>


<p>进入root模式，这个时候可以配置iptables：</p>

<pre><code># iptables -A OUTPUT -t tcp -d 192.168.1.2 -j NFQUEUE
</code></pre>

<p>这样到192.168.1.2的所有TCP包都会进入NFQUEUE等着被处理。</p>

<ul>
<li><p>此时我们需要写程序来处理NFQUEUE里面的包，首先我们在PC上新建一个Android项目：</p>

<p>  $ android create project &#8211;target <target_ID> -name IptablesTest &#8211;path ./IptablesTest &#8211;activity IptablesTestActivity  &#8211;package com.iptables.test
  $ cd IptablesTest
  $ mkdir jni</p></li>
</ul>


<p>接下来，要下载两个包（<a href="http://www.netfilter.org/projects/libnfnetlink/downloads.html">libnfnetlink</a>和<a href="http://www.netfilter.org/projects/libnetfilter_queue/downloads.html">libnetfilter_queue</a>）到jni目录下。</p>

<p>然后在jni目录下创建一个文件叫做nfqnl_test.c：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;linux/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;linux/netfilter.h&gt;       </span><span class="cm">/* for NF_ACCEPT */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;libnetfilter_queue/libnetfilter_queue.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* returns packet id */</span>
</span><span class='line'><span class="k">static</span> <span class="n">u_int32_t</span> <span class="nf">print_pkt</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfq_data</span> <span class="o">*</span><span class="n">tb</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">nfqnl_msg_packet_hdr</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">nfqnl_msg_packet_hw</span> <span class="o">*</span><span class="n">hwph</span><span class="p">;</span>
</span><span class='line'>  <span class="n">u_int32_t</span> <span class="n">mark</span><span class="p">,</span><span class="n">ifi</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ph</span> <span class="o">=</span> <span class="n">nfq_get_msg_packet_hdr</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">id</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">packet_id</span><span class="p">);</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hw_protocol=0x%04x hook=%u id=%u &quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">ntohs</span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">hw_protocol</span><span class="p">),</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">hook</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hwph</span> <span class="o">=</span> <span class="n">nfq_get_packet_hw</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hwph</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">hlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hwph</span><span class="o">-&gt;</span><span class="n">hw_addrlen</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hw_src_addr=&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hlen</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%02x:&quot;</span><span class="p">,</span> <span class="n">hwph</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">hwph</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">[</span><span class="n">hlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mark</span> <span class="o">=</span> <span class="n">nfq_get_nfmark</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;mark=%u &quot;</span><span class="p">,</span> <span class="n">mark</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ifi</span> <span class="o">=</span> <span class="n">nfq_get_indev</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ifi</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;indev=%u &quot;</span><span class="p">,</span> <span class="n">ifi</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ifi</span> <span class="o">=</span> <span class="n">nfq_get_outdev</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ifi</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;outdev=%u &quot;</span><span class="p">,</span> <span class="n">ifi</span><span class="p">);</span>
</span><span class='line'>  <span class="n">ifi</span> <span class="o">=</span> <span class="n">nfq_get_physindev</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ifi</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;physindev=%u &quot;</span><span class="p">,</span> <span class="n">ifi</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ifi</span> <span class="o">=</span> <span class="n">nfq_get_physoutdev</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ifi</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;physoutdev=%u &quot;</span><span class="p">,</span> <span class="n">ifi</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ret</span> <span class="o">=</span> <span class="n">nfq_get_payload</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;payload_len=%d &quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fputc</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfq_q_handle</span> <span class="o">*</span><span class="n">qh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfgenmsg</span> <span class="o">*</span><span class="n">nfmsg</span><span class="p">,</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">nfq_data</span> <span class="o">*</span><span class="n">nfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">u_int32_t</span> <span class="n">id</span> <span class="o">=</span> <span class="n">print_pkt</span><span class="p">(</span><span class="n">nfa</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;entering callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">nfq_set_verdict</span><span class="p">(</span><span class="n">qh</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">NF_ACCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">nfq_handle</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">nfq_q_handle</span> <span class="o">*</span><span class="n">qh</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">nfnl_handle</span> <span class="o">*</span><span class="n">nh</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;opening library handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">h</span> <span class="o">=</span> <span class="n">nfq_open</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error during nfq_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;unbinding existing nf_queue handler for AF_INET (if any)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">nfq_unbind_pf</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error during nfq_unbind_pf()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;binding nfnetlink_queue as nf_queue handler for AF_INET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">nfq_bind_pf</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error during nfq_bind_pf()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;binding this socket to queue &#39;0&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">qh</span> <span class="o">=</span> <span class="n">nfq_create_queue</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qh</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error during nfq_create_queue()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;setting copy_packet mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">nfq_set_mode</span><span class="p">(</span><span class="n">qh</span><span class="p">,</span> <span class="n">NFQNL_COPY_PACKET</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;can&#39;t set packet_copy mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">nfq_fd</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">rv</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pkt received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">nfq_handle_packet</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ENOBUFS</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;losing packets!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">perror</span><span class="p">(</span><span class="s">&quot;recv failed&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;unbinding from queue 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">nfq_destroy_queue</span><span class="p">(</span><span class="n">qh</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;closing library handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">nfq_close</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的原理很简单，就是通过：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">qh</span> <span class="o">=</span> <span class="n">nfq_create_queue</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>注册了一个callback函数cb，在</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">nfq_handle_packet</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>的时候就会将收到的包传给该函数进行处理，当然了，还可以像<a href="http://ytliu.github.io/blog/2013/03/29/netfilterxue-xi-bi-ji-%28er-%29/">这里</a>一样通过<code>struct iphdr</code>和<code>struct tcphdr</code>结构体来获得payload里面的IP包头和TCP包的信息，对其进行处理。</p>

<ul>
<li>之后在jni目录下创建<code>Android.mk</code>文件：</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#LOCAL_PATH is used to locate source files in the development tree.</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#the macro my-dir provided by the build system, indicates the path of the current directory</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_PATH:</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">call</span> <span class="n">my</span><span class="o">-</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#####################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#            build libnflink                    #</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#####################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">CLEAR_VARS</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_MODULE:</span><span class="o">=</span><span class="n">nflink</span>
</span><span class='line'>
</span><span class='line'><span class="n">LOCAL_C_INCLUDES</span> <span class="o">:=</span> <span class="err">$</span><span class="p">(</span><span class="n">LOCAL_PATH</span><span class="p">)</span><span class="o">/</span><span class="n">libnfnetlink</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">include</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_SRC_FILES:</span><span class="o">=</span>\
</span><span class='line'>
</span><span class='line'>    <span class="n">libnfnetlink</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">iftable</span><span class="p">.</span><span class="n">c</span> \
</span><span class='line'>
</span><span class='line'>    <span class="n">libnfnetlink</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rtnl</span><span class="p">.</span><span class="n">c</span> \
</span><span class='line'>
</span><span class='line'>    <span class="n">libnfnetlink</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">libnfnetlink</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">BUILD_STATIC_LIBRARY</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include $(BUILD_SHARED_LIBRARY)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#####################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#            build libnetfilter_queue            #</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#####################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">CLEAR_VARS</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">LOCAL_C_INCLUDES</span> <span class="o">:=</span> <span class="err">$</span><span class="p">(</span><span class="n">LOCAL_PATH</span><span class="p">)</span><span class="o">/</span><span class="n">libnfnetlink</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">include</span> \
</span><span class='line'>
</span><span class='line'>    <span class="err">$</span><span class="p">(</span><span class="n">LOCAL_PATH</span><span class="p">)</span><span class="o">/</span><span class="n">libnetfilter_queue</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">include</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_MODULE:</span><span class="o">=</span><span class="n">netfilter_queue</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_SRC_FILES:</span><span class="o">=</span><span class="n">libnetfilter_queue</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">libnetfilter_queue</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_STATIC_LIBRARIES:</span><span class="o">=</span><span class="n">libnflink</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">BUILD_STATIC_LIBRARY</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include $(BUILD_SHARED_LIBRARY)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#####################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#            build our code                    #</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#####################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">CLEAR_VARS</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">LOCAL_C_INCLUDES</span> <span class="o">:=</span> <span class="err">$</span><span class="p">(</span><span class="n">LOCAL_PATH</span><span class="p">)</span><span class="o">/</span><span class="n">libnfnetlink</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">include</span> \
</span><span class='line'>
</span><span class='line'>    <span class="err">$</span><span class="p">(</span><span class="n">LOCAL_PATH</span><span class="p">)</span><span class="o">/</span><span class="n">libnetfilter_queue</span><span class="o">-</span><span class="mf">1.0.0</span><span class="o">/</span><span class="n">include</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_MODULE:</span><span class="o">=</span><span class="n">nfqnltest</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_SRC_FILES:</span><span class="o">=</span><span class="n">nfqnl_test</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_STATIC_LIBRARIES:</span><span class="o">=</span><span class="n">libnetfilter_queue</span>
</span><span class='line'>
</span><span class='line'><span class="nl">LOCAL_LDLIBS:</span><span class="o">=-</span><span class="n">llog</span> <span class="o">-</span><span class="n">lm</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include $(BUILD_SHARED_LIBRARY)</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">BUILD_EXECUTABLE</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>之后，调用ndk-build来创建可执行文件nfqnltest，它位于libs目录下。</p></li>
<li><p>将nfqnltest传进Android中：</p>

<p>  $ adb shell
  $ su
  # mkdir /data/data/nfqnltest
  # chmod 777 /data/data/nfqnltest</p></li>
</ul>


<p>打开一个shell：</p>

<pre><code>$ adb push libs/nfqnltest /data/data/nfqnltest/”
</code></pre>

<p>转回刚刚那个shell</p>

<pre><code># cd /data/data/nfqnltest
# ./nfqnltest
</code></pre>

<p>这样整个过程就完成了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/29/netfilterxue-xi-bi-ji-%28er-%29/">Netfilter学习笔记（二）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-29T20:26:00+08:00" pubdate data-updated="true">Mar 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>之前讲了关于netfilter和iptables的一些简单的原理和用法，对于iptables来说，如果只能对封包进行DROP、ACCEPT操作，那么就显得太弱了，其实在我看来iptables里面filter表中最牛逼的就在于QUEUE（NFQUEUE）这个target了。</p>

<p>那么当iptables将封包插入QUEUE后，用户态又能用什么方法才能读到queue中的数据呢？</p>

<p>这里介绍两种方法，一种是C语言中使用的<code>libipq</code>，一种是python中使用的<code>nfqueue</code>。</p>

<h3>libipq</h3>

<p><code>libipq</code>是一个对开发者提供的用于读取iptables queue的C库，具体的用法可以参看<a href="http://linux.die.net/man/3/libipq">linux man page</a>和<a href="http://www.imchris.org/projects/libipq.html">这里</a>的用法，需要注意的是在我的机器中必须得再加三个头文件：</p>

<pre><code>#include &lt;netinet/in.h&gt;
#include &lt;linux/ip.h&gt;
#include &lt;linux/tcp.h&gt;
</code></pre>

<p>另外编译出来的文件必须得用<code>sudo</code>执行！！！</p>

<p>这里主要用了一个数据结构</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">ipq_handle</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="n">ipq_create_handle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外需要设置一个模式，这里是<code>IPQ_COPY_PACKET</code>，即是将queue中的封包的payload和header一起拷贝到用户空间：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">status</span> <span class="o">=</span> <span class="n">ipq_set_mode</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">IPQ_COPY_PACKET</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>之后通过：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">status</span> <span class="o">=</span> <span class="n">ipq_read</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>将queueu中的封包一个一个拷贝到用户空间，由用户进行操作，用户可以通过：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">ipq_message_type</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>得到包的类型，可能是<code>NLMSG_ERROR</code>，也有可能是<code>IPQM_PACKET</code>，如果是后者，即为一个正常的封包，可以通过类似于如下的代码对封包进行操作：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">IPQM_PACKET</span>: <span class="p">{</span>
</span><span class='line'>  <span class="n">ipq_packet_msg_t</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ipq_get_packet</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">payload</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>         
</span><span class='line'>
</span><span class='line'>  <span class="n">status</span> <span class="o">=</span> <span class="n">ipq_set_verdict</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">packet_id</span><span class="p">,</span> <span class="n">NF_ACCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">die</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上段代码的意思是先从<code>buf</code>中获得整个封包m，之后可以通过<code>struct iphdr</code>和<code>struct tcphdr</code>获得ip包头和tcp包头，最后有一个最关键的代码：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">status</span> <span class="o">=</span> <span class="n">ipq_set_verdict</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">packet_id</span><span class="p">,</span> <span class="n">NF_ACCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的意思相当于原来在规则中target设为ACCEPT，当然也可以设置成<code>NF_DROP</code>等。</p>

<p>在这里我有一个疑问，就是这里除了获得<code>struct tcphdr</code>之外，我没有找到和TCP的payload相关的结构，不知道该如何获得。</p>

<hr />

<h3>nfqueue</h3>

<p>和C的libipq比起来，支持python的nfqueue会显得强大很多，特别是和<a href="http://www.secdev.org/projects/scapy/">scapy</a>结合起来用的时候。</p>

<p>首先需要说明的是在iptables中的target除了之前提到的五项（ACCEPT，DROP，RETURN，QUEUE，other_chain）之外，还有一个叫<code>NFQUEUE</code>，它是QUEUE的扩展。相比于QUEUE，它可以由用户指定不同的queue number。</p>

<p>在使用nfqueue之前，需要安装如下的包：</p>

<pre><code>$ sudo aptitude install libnetfilter-queue-dev
$ sudo aptitude install nfqueue-bindings-python
$ sudo aptitude install python-scapy
</code></pre>

<p>之后就可以采用python对NFQUEUE进行操作了。</p>

<p>假设我们将封包从主机A（<code>192.168.1.1</code>）传输到主机B（<code>192.168.1.2</code>）时，需要对封包进行分析，如果是TCP协议的包，并且其flags为 ACK|PSH 的话，则将其payload进行修改（比如替换成“hack”）：</p>

<p>首先，需要先在主机A中对iptables进行操作：</p>

<pre><code>$ sudo iptables -A OUTPUT -d 192.168.1.2 -p tcp -j NFQUEUE
</code></pre>

<p>然后利用下面的代码：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">nfqueue</span><span class="o">,</span><span class="nn">socket</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">ch_payload_and_send</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
</span><span class='line'>  <span class="n">pkt</span><span class="p">[</span><span class="n">TCP</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span> <span class="o">==</span> <span class="s">&quot;hack&quot;</span>
</span><span class='line'>  <span class="n">send</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</span><span class='line'>  <span class="n">pkt</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Check if TCP flags is ACK|PSH</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">pkt</span><span class="p">[</span><span class="n">TCP</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
</span><span class='line'>      <span class="c"># Dropping the packet</span>
</span><span class='line'>      <span class="n">payload</span><span class="o">.</span><span class="n">set_verdict</span><span class="p">(</span><span class="n">nfqueue</span><span class="o">.</span><span class="n">NF_DROP</span><span class="p">)</span>
</span><span class='line'>      <span class="n">ch_payload_and_send</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="c"># Accepting the packet</span>
</span><span class='line'>      <span class="n">payload</span><span class="o">.</span><span class="n">set_verdict</span><span class="p">(</span><span class="n">nfqueue</span><span class="o">.</span><span class="n">NF_ACCEPT</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>  <span class="n">q</span> <span class="o">=</span> <span class="n">nfqueue</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
</span><span class='line'>  <span class="n">q</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</span><span class='line'>  <span class="n">q</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
</span><span class='line'>  <span class="n">q</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
</span><span class='line'>  <span class="n">q</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
</span><span class='line'>  <span class="n">q</span><span class="o">.</span><span class="n">create_queue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span><span class="p">:</span>
</span><span class='line'>      <span class="n">q</span><span class="o">.</span><span class="n">try_run</span><span class="p">()</span>
</span><span class='line'>  <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&quot;Exiting...&quot;</span>
</span><span class='line'>      <span class="n">q</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
</span><span class='line'>      <span class="n">q</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里用到了<code>scapy</code>这个非常牛逼的模块，它可以直接通过如<code>IP()</code>，<code>TCP()</code>等直接对包进行解释和操作，非常方便，具体的可以参看它的<a href="http://www.secdev.org/projects/scapy/doc/">文档</a>。这里只是说明下它的安装方式：</p>

<pre><code>$ wget scapy.net
$ mv index.html scapy-latest.zip
$ chmod +x scapy-latest.zip
$ mv scapy-latest.zip /usr/local/bin/scapy
</code></pre>

<p>然后就可以运行：</p>

<pre><code>$ sudo scapy
</code></pre>

<p>直接开启scapy的交互模式了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/29/netfilterxue-xi-bi-ji-%28yi-%29/">Netfilter学习笔记（一）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-29T18:39:00+08:00" pubdate data-updated="true">Mar 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这两天在学习<code>iptables</code>，感觉这个东西实在是太牛逼！想用两篇博文来介绍一番。</p>

<p>第一篇会介绍下netfilter和iptables的关系，以及iptables的原理；第二篇希望通过<code>libipq</code>和<code>nfqueue-bindings-python</code>来介绍下user态如何利用C和Python来调用iptables的接口获得封包的信息。</p>

<h3>netfilter</h3>

<p>简单地说，netfilter是一套在计算机网络栈中过滤和修改封包的框架，它的做法是在Linux Kernel中插入了一系列的hook，并允许kernel在不同层的网络栈中注册回调函数，这些回调函数会在封包进入相应的hook的时候被调用到。</p>

<p>网络栈中对netfilter的支持如图所示：</p>

<p><img src="http://ytliu.github.com/images/2013-03-29-1.png" title="package flow in netfiter and general networking" alt="netfilter" /></p>

<p>可以看到在链路层和网络层中按照封包流的路径有五种类型的hooks: prerouting, input, forward, output, postrouting。这五种hooks会在封包到达之时按照封包流的顺序调用相应的回调函数，对四种类型的表中的chain（会在iptables中描述）进行过滤和修改：filter, nat, mangle, raw。而定义这些过滤的规则则是由一个用户态的命令<code>iptables</code>进行配置，也就是我接下来要详细描述的命令。</p>

<h3>iptables</h3>

<p><a href="http://itzone.hk/article/index.php?tid=14">这里</a>有6篇系列的文章介绍iptables的，讲的挺清楚，蛮适合入门学习的。</p>

<p>前面说过iptables有四种类型的表：filter，nat，mangle，raw，这里只是对filter表进行介绍：</p>

<p>filter表主要用于对封包进行过滤，在该表中有三条默认的chain：INPUT，FORWARD，OUTPUT。</p>

<p>chain是做什么的呢？(转自<a href="http://itzone.hk/article/article.php?aid=200502091507054036">这里</a>)</p>

<blockquote><p>所謂chain就是一組封包過濾規則，您可以在INPUT chain中加入一條防止所有外界封包進入的規則；您可以在OUTPUT chain中加入一條防止用戶連接某網頁伺服器。準備進入網絡的封包，會順著chain內的過濾規則被稽核，若果該封包並不符合任何規則，則會直接進入網 內，因為INPUT和OUTPUT在Linux kernel裡被預設為ACCEPT，而FORWARD則被預設為DROP。</p></blockquote>

<p>比如说，如果要把发到某个地址（如192.168.1.2）的包丢弃，可以这样做：</p>

<pre><code>$ sudo iptables -A OUTPUT -d 192.168.1.2 -j DROP
</code></pre>

<p>这里<code>-A</code>指对OUTPUT这条链的规则进行修改，<code>-d</code>表示这个封包的destination，<code>-j</code>后加的是target，有五种选择：ACCEPT（不作任何操作，让封包流过），DROP（将封包丢弃），QUEUE（将封包插入队列，传递到用户态处理，这个会在第二篇中详细描述），RETURN（直接从该chain中返回，到前一个chain的下一条规则继续执行），以及自己定义的CHAIN，如下：</p>

<pre><code>$ sudo iptables -N SELF_CHAIN
</code></pre>

<p>也就是说我们可以按照不同的源地址、目标地址、端口、协议等规则分类，由不同的chain进行处理，可以更合理地对过滤条件进行管理。</p>

<p>另外，有几个常用的选项这里提一下：</p>

<pre><code>-A chain                # modify a chain
-D chain rulenum        # delete a specific rule of chain
-I chain rulenum rule   # insert rule in rulenum of chain
-R chain rulenum rule   # replace rule with rulenum of chain
-L [chain]              # list rules of chain
-F [chain]              # flush the rules of chain
-N chain                # new a chain
-X [chain]              # delete chain

-p protocol             # e.g., tcp, udp, icmp...
-s source address       # e.g., 192.168.1.22
-d destination address  # e.g., 192.168.1.13
-j target               # e.g., ACCEPT, DROP, RETURN, QUEUE, other-chain
-i in-interface         # e.g., eth0
-o out-interface        # e.g., eth0
</code></pre>

<hr />

<p>下一篇主要介绍当<code>iptables</code>的target是QUEUE或者NFQUEUE时，用户态要如何调用相关接口。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/24/cross-reference-graph-of-android-component/">Cross Reference Graph of Android Component</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-24T13:35:00+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>由于项目的需要，这周写了一个ruby project——<a href="https://github.com/ytliu/apk-static-xref">apk-static-xref</a>。</p>

<p>虽然现在Android静态分析的项目很多，但是我都没有找到一个看上去很简单的功能：给定一个component，找出它所有调用到的函数，然后画出call graph。</p>

<p>现在的大部分call graph都只能限制在一个class文件里，这里所说的cross reference graph (XRG)就是指函数调用是跨class文件的，需要cross reference直到调用的是Android本身的API或者Java API。</p>

<p>这其实是一个很简单的功能，但我不知道为什么一直找不到工具可以满足我的需求，直到找到了spark的一个<a href="http://appsrv.cse.cuhk.edu.hk/~mzheng/DroidTrace.pdf">slide</a>，里面提到一个cross reference graph。其实就是一个对smali文件的DFS算法。</p>

<p>于是我把<a href="">smali-cfg</a>和<a href="">redexer</a>结合了一下，写了这个ruby project，具体做法就是：</p>

<ul>
<li><p>用apktool unpack apk：</p>

<p>  $ java -jar apktool.jar -d source.apk target.dir</p></li>
<li><p>用nokogiri parse AndroidManefest.xml 找出所有的service和activity：</p>

<p>  Nokogiri::XML(f)</p></li>
<li><p>用DFS遍历所有的smali文件，得出整个call graph的结点和边：</p></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_assign</span><span class="p">(</span><span class="n">apk</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">pty</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">ori_cls</span><span class="p">)</span>
</span><span class='line'>  <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="nb">caller</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">callee</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">vclass</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="n">filename</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="n">smali</span> <span class="o">+</span> <span class="n">cls</span> <span class="o">+</span> <span class="s2">&quot;.smali&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fh</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="n">lines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;.class&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vclass</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">[-</span><span class="mi">1</span><span class="o">][</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;.method&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">caller</span> <span class="o">=</span> <span class="no">Invoker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">vclass</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">caller</span><span class="o">.</span><span class="n">mtd</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="n">mtd</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">caller</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="n">pty</span><span class="p">))</span>
</span><span class='line'>        <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;.end method&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;invoke-&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">callee</span> <span class="o">=</span> <span class="no">Invoked</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="vg">$caller_methods</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">callee</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">!</span><span class="vg">$caller_methods</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">caller</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>
</span><span class='line'>            <span class="n">addNodes</span><span class="p">(</span><span class="nb">caller</span><span class="o">.</span><span class="n">str</span><span class="p">,</span> <span class="n">callee</span><span class="o">.</span><span class="n">str</span><span class="p">)</span> <span class="k">if</span> <span class="vg">$graph_need</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">addNodes</span><span class="p">(</span><span class="nb">caller</span><span class="o">.</span><span class="n">str</span><span class="p">,</span> <span class="n">callee</span><span class="o">.</span><span class="n">str</span><span class="p">)</span> <span class="k">if</span> <span class="vg">$graph_need</span>
</span><span class='line'>          <span class="vg">$caller_methods</span> <span class="o">&lt;&lt;</span> <span class="nb">caller</span><span class="o">.</span><span class="n">str</span>
</span><span class='line'>          <span class="n">run_assign</span><span class="p">(</span><span class="n">apk</span><span class="p">,</span> <span class="n">callee</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">callee</span><span class="o">.</span><span class="n">mtd</span><span class="p">,</span> <span class="n">callee</span><span class="o">.</span><span class="n">pty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ori_cls</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>用ruby-graphviz画出call graph</p>

<p>  $graph.output(:png => &#8220;#{to}.png&#8221;)</p></li>
</ul>


<p>其实整个过程非常的简单，不过可能自己代码写得比较烂，会不太好理解。另外，现在是先用apktool把apk翻译成smali之后再对smali进行操作，效率可能会比较慢，接下来准备把实现改成直接对dex文件进行分析，打算基于Android自带的dexdump或者开源的baksmali，顺便把dex的格式搞得更加清楚一点。</p>

<hr />

<p>由于下周一门课的原因，这周又把OSDI 2012的<a href="http://research.microsoft.com/pubs/173922/appinsight.pdf">AppInsight</a>的论文仔细看了一遍，觉得确实是做得很好很有用的一个系统。我希望自己能把它实现在Android上。其实整个原理也不是非常的难，我想最难的部分在于Windows本来就有一个Detour可以直接利用来做instrumentation和interception，非常的方便，但是Java本身好像没有一个相当的库，需要自己实现一遍。</p>

<p>不知道这个计划需要多久才能完成，我可能要先找个和Detour功能类似的库改一改，希望这个作为自己第一个比较正式的开源项目不会中途破产吧。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/10/redexer-and-ocaml/">Redexer and Ocaml</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-10T09:53:00+08:00" pubdate data-updated="true">Mar 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在<a href="http://ytliu.github.com/blog/2013/03/01/dr-android-and-mr-hide-xidashiyin-fa-de-gu-shi/">上一篇博客</a>是一个用ruby和OCaml写的Dalvik binary rewriter，它提供了unparse, htmlunparse, id, combine, info, classes, api, opstat, cg, cfg, dom, pdom, dump_method等功能，还可以自己扩展相应的功能，具体的可以参看它的<a href="https://github.com/plum-umd/redexer">github主页</a>。</p>

<p>redexer主要原理就是将<code>.dex</code>文件按照<a href="http://source.android.com/tech/dalvik/dex-format.html">Dalvik Executable Format</a>映射到内存中的数据结构，然后根据这些数据结果进行分析，可以达到比较高的性能。</p>

<p>这里主要想要说说<a href="http://en.wikipedia.org/wiki/OCaml">OCaml</a>这个语言。</p>

<p>OCaml的全称是Object Caml，是一个有OO扩展的函数式语言（Functional Language），看了看它的语法，和我们程序语言理论里面的那个simPL非常的像，也和当时学FP的时候讲的Haskell很像。</p>

<p>查了查functional language和imperative language有什么不同，在wiki上似乎有一个最大的区别在于：</p>

<pre><code>It emphasizes the application of functions, in contrast to the imperative programming style, 
which emphasizes changes in state. The most significant differences stem from the fact that 
functional programming avoids side effects, which are used in imperative programming to implement 
state and I/O. 
</code></pre>

<p>然后在<a href="http://stackoverflow.com/questions/2078978/functional-programming-vs-object-oriented-programming">stack overflow</a>里面有一个蛮经典的回答”When do you choose functional programming over object oriented ?“</p>

<p><img src="http://ytliu.github.com/images/2013-03-10-1.png" title="answer" alt="stackoverflowans" /></p>

<p>另外，在OCaml里面有很多FP的特性，比如 static type system, type inference, parametric polymorphism, tail recursion, pattern matching, first class lexical closures, functors (parametric modules), exception handling, and incremental generational automatic garbage collection等等，这些会在之后对OCaml的学习中慢慢弄清楚来吧~</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/01/dr-android-and-mr-hide-xidashiyin-fa-de-gu-shi/">Dr. Android and Mr. Hide - Xidashi引发的故事</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-01T20:00:00+08:00" pubdate data-updated="true">Mar 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>故事得从几天前利小哥发现的<a href="www.xidashi.com">xidashi</a>说起：</p>

<p><img src="http://ytliu.github.com/images/2013-03-01-1.png" title="xidashi" alt="xidashi" /></p>

<p>洗大师是一个android的安全应用软件+第三方应用市场，它的功能和特点简单来说就是：</p>

<blockquote><p>在不root的情况下，允许用户对已安装的应用程序实行权限的细粒度动态控制</p></blockquote>

<p>这里的细粒度动态控制是指用户可以随时允许或禁止该应用程序某一个权限，并对利用该权限调用API的行为进行log。</p>

<p>洗大师的流程是这样子的：</p>

<p>上传apk -> 服务器对apk进行”清洗“ -> 返回”清洗“过后的apk并安装 -> 在apk运行过程中进行动态权限控制</p>

<p>当然还有一种模式就是”直接下载洗大师market提供的应用“。</p>

<p>咋一看，这真的是一个非常牛逼的应用，在没有root的情况下可以对每个应用进行细粒度动态权限控制，这样用户就再也不用担心恶意程序利用过渡申请的权限做坏事了！</p>

<p>而且从实现上来看，利小哥刚开始写了一个很简单的测试程序，用洗大师”洗“了洗，发现它就加了一个包，而没有对原来的程序进行任何修改，我们都觉得不可思议！amazing！！！讨论了下觉得这是不可能的，然后斌哥就在网上找到了这一篇文章<a href="http://www.cs.umd.edu/~jfoster/papers/acplib.pdf">Dr. Android and Mr. Hide: Fine-grained security policies on unmodiﬁed Android</a>，这是一篇基于spsm2012的technical report，然后再重新写了个测试程序用洗大师”洗“了洗，发现其实它还是改了应用程序原来的binary的。于是乎，就感觉被骗了一样。不过仔细想来，其实洗大师这种方式不失为一种解决恶意程序权限泛滥的好办法，不知道洗大师的作者是看了这篇论文做出的洗大师还是自己想出来的，这种创业产品还是比较有效的，特别是如果它的第三方市场能够更加普及一点的话。当然啦，我们都觉得这个技术并不是一个高不可攀的技术，对于腾讯、360这种xx公司来说，要实现类似的功能应该还是挺快的。我去关注了下洗大师的新浪微博，发现它现在的粉丝并不多，不知道洗大师最后能牛逼到什么程度，祝君好运吧。</p>

<hr />

<p>扯了那么多闲话，开始进入正题，这一篇《Dr. Android and Mr. Hide》从效果上来说和洗大师还是有一点不同的，但是我觉得实现原理应该不会差太远，这里简单介绍下吧：</p>

<p>它的motivation是这样的：</p>

<p>现在Android的权限系统粒度太粗了，举个例子：如果一个应用程序，比如”大众点评“（点评躺着中枪了），申请了一个INTERNET权限，那么它就可以访问所有的网络了，但是实际上它只需要访问www.dianping.com这一个域名，那么一个恶意程序或者repackage的程序就可以利用它的网络权限窃取一些隐私数据传到某个服务器，这种方式并没有违反Android的权限系统。那么这篇paper的目的就是在不修改Android Framework的情况下将权限细化，比如把INTERNET改成InternetURL(d)，使得有后者权限的应用只能访问<code>d</code>这个URL。</p>

<p>这里需要说明的是，在这种安全防护模式下有两种方法可以做：</p>

<ul>
<li>修改Android Framework，换一种方式，从用户的角度来说也就是root，或者刷机；</li>
<li>对应用程序进行instrumentation，也就是将应用程序改一改，然后repackage一下。当然这个步骤应该是可以自动化的。</li>
</ul>


<p>对于前者来说，需要google或者一些设备提供商的支持，或者用户进行root；对于后者来说，谁来进行instrumentation，instrumentation产生的side effect都是需要考虑的问题。</p>

<p>这篇文章采用了第二种方式，而它的方法其实是很直观的：</p>

<p><img src="http://ytliu.github.com/images/2013-03-01-2.png" title="Mr. Hide" alt="mrhide" /></p>

<p><img src="http://ytliu.github.com/images/2013-03-01-3.png" title="Dr. Android" alt="drandroid" /></p>

<ul>
<li>首先，将apk中的粗粒度权限换成细粒度权限；</li>
<li>然后在apk中插入一个library（文中为hidelib），并通过一个自动化工具Dr. Android找出应用程序中所有对sensitive API的调用，将其换成hidelib中对应的API调用；</li>
<li>hidelib中的API会首先对应用的权限进行一个检查，然后和Mr. Hide进行交互，Mr. Hide是一个运行在另一个进程中的Service，它可以根据hidelib传送过来的信息进行相应的调用，并将结果返回。</li>
</ul>


<p>当然，这里面会牵扯到很多细节问题，比如应用程序怎么样和Mr. Hide进行binding，如何保护Mr. Hide不被恶意程序利用，以及如何精确而又高效地对原始apk进行instrumentation，还有很多Android中签名机制的问题等等，这里就不一一阐述了。</p>

<hr />

<p>值得一提的是，这篇paper中提到的Dr. Android是一个叫做<a href="http://www.cs.umd.edu/projects/PL/redexer/about.html">redexer</a>的开源项目，也就是作者开发的。redexer是一个用ruby和OCaml写的Dalvik Binary Rewriter，效率很高，功能也挺强大的。我在之后的博客中会对其进行一个介绍。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/23/traceview-in-android/">Traceview in Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-23T15:54:00+08:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这两天尝试了下用Android自带的<a href="http://developer.android.com/tools/debugging/debugging-tracing.html">Traceview</a>进行profile，感觉蛮有意思的，而且发现它的文档上对数据格式的说明和我实现时候碰到的情况有出入，于是在google code上发了封<a href="https://code.google.com/p/android/issues/detail?id=51286">帖</a>（<a href="https://code.google.com/p/android/issues/detail?id=50930#makechanges">前一封</a>被华丽丽地无视掉了），但是到最后还是不明白到底是什么问题，维护文档的人好不热情啊&#8230;</p>

<p>反正这里还是按照我的实验情况来解释吧:-)</p>

<p>首先得解释下什么是Traceview。最简单而且最普遍的Traceview的流程是这样子的：</p>

<ul>
<li>用户首先要对源代码进行一些instrumentation，如下所示：</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="c1">// start tracing to &quot;/sdcard/calc.trace&quot;</span>
</span><span class='line'>    <span class="n">Debug</span><span class="o">.</span><span class="na">startMethodTracing</span><span class="o">(</span><span class="s">&quot;calc&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="c1">// stop tracing</span>
</span><span class='line'>    <span class="n">Debug</span><span class="o">.</span><span class="na">stopMethodTracing</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>之后当运行到<code>Debug.startMethodTracing</code>时，系统就会进入Trace模式，在<code>/sdcard</code>目录下创建一个<code>calc.trace</code>文件，并动态地将之后的所有函数调用都trace进这个文件中（当然也包括framework中的API调用）；</li>
<li>然后就可以利用Android提供的Traceview工具或者dmtracedump工具对这个文件进行分析了。</li>
</ul>


<p>其中通过Traceview可以获得很多非常有用的信息，包括Timeline Panel和Profile Panel，具体的可以参见Traceview的<a href="http://developer.android.com/tools/debugging/debugging-tracing.html">document</a>，这里就不阐述了。而通过dmtracedump工具可以得到整个运行过程中的call-stack diagram。</p>

<p>不过目前的dmtracedump的call-graph功能还没有实现，于是我从网上找到一个用python脚本写的<a href="http://blog.csdn.net/zjujoe/article/details/6080738">dmtracedump替代</a>，一开始不能用，于是debug了一通，从而发现了前面说的和Traceview官方文档的出入。下面主要就是解释一下有何出入：</p>

<p>首先要介绍下官方文档中由Debug产生的Traceview的文件格式是怎样的：</p>

<p>cal.trace主要分为两个部分 —— key和data。</p>

<p>key部分的格式是这样的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*version
</span><span class='line'>1
</span><span class='line'>clock=global
</span><span class='line'>*threads
</span><span class='line'>1 main
</span><span class='line'>6 JDWP Handler
</span><span class='line'>5 Async GC
</span><span class='line'>4 Reference Handler
</span><span class='line'>3 Finalizer
</span><span class='line'>2 Signal Handler
</span><span class='line'>*methods
</span><span class='line'>0x080f23f8 java/io/PrintStream write ([BII)V
</span><span class='line'>0x080f25d4 java/io/PrintStream print (Ljava/lang/String;)V
</span><span class='line'>0x080f27f4 java/io/PrintStream println (Ljava/lang/String;)V
</span><span class='line'>0x080da620 java/lang/RuntimeException   &lt;init>    ()V
</span><span class='line'>[...]
</span><span class='line'>0x080f630c android/os/Debug startMethodTracing ()V
</span><span class='line'>0x080f6350 android/os/Debug startMethodTracing (Ljava/lang/String;Ljava/lang/String;I)V
</span><span class='line'>*end</span></code></pre></td></tr></table></div></figure>


<p>它分为了3个sections，每一个section由<code>*</code>开头：</p>

<ul>
<li>version section;</li>
<li>threads section：主要记录了thread ID和thread Name，其中thread ID会在data部分中被引用；</li>
<li>methods section：主要记录了method ID和method signature，其中method ID用于被data部分的record引用。</li>
</ul>


<p>data部分的格式是这样的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* File format:
</span><span class='line'>* header
</span><span class='line'>* record 0
</span><span class='line'>* record 1
</span><span class='line'>* ...
</span><span class='line'>*
</span><span class='line'>* Header format:
</span><span class='line'>* u4 magic 0x574f4c53 ('SLOW')
</span><span class='line'>* u2 version
</span><span class='line'>* u2 offset to data
</span><span class='line'>* u8 start date/time in usec
</span><span class='line'>*
</span><span class='line'>* Record format:
</span><span class='line'>* u1 thread ID
</span><span class='line'>* u4 method ID | method action
</span><span class='line'>* u4 time delta since start, in usec</span></code></pre></td></tr></table></div></figure>


<p>它由heade和一系列的records组成，其中在header里面有一个域叫offset to data，由此可以找到第一个record的地址，而每一个record由三部分组成：</p>

<ul>
<li>thread ID：就是在key里面的那个thread ID；</li>
<li>method ID | method action：就是在key里面的那个method ID，method action有四种情况: {0->method entry; 1->method exit; 2->method exited by exception handling; 3->reversed};</li>
<li>time：就是这个action发生的时间，正常情况下时间都是按照升序排序的。</li>
</ul>


<p>有了这个trace文件以及事先协议好的格式，就可以进行分析了。即对每一个record进行遍历，得到每个时间点的函数调用，并将它们串起来，就可以得到很多信息。</p>

<p>但是在我的实验中，发现data部分中每个record不是像文档中描述的那样是由9个bytes组成的，而是14个bytes组成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* Record format:
</span><span class='line'>* u2 thread ID
</span><span class='line'>* u4 method ID | method action
</span><span class='line'>* u8 time delta since start, in usec</span></code></pre></td></tr></table></div></figure>


<p>我的猜想是和产生trace文件时机器的配置有关，我的系统是Debian 6.0，x86_64，维护文档的人似乎没有回答我，不过根据后面一个回答，好像确实在新的版本中就是14个bytes。</p>

<p>Anyway，不管怎么样，这个trace文件是可以提供非常多动态信息的，但是需要对源代码进行修改，并且可能会产生比较大的运行时overhead（自己猜的，没有验证）。不过按照文档上的说法还有一种方式是采用<a href="http://developer.android.com/tools/debugging/ddms.html">DDMS</a>，不过我也没有尝试过，就不在这里阐述了。</p>

<hr />

<p>另外，Python脚本我就不帖出来了，我用ruby重新实现了一遍，这是可以在我的机器上work的版本：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># dmtracedump.rb</span>
</span><span class='line'><span class="c1"># turn the traceview data into a png pic, showing methods call relationship</span>
</span><span class='line'>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'><span class="c1">########################  Global Variable  #####################################</span>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'><span class="vi">@target_thread</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="vi">@all_threads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@all_methods</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@all_records</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="vi">@parent_methods</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@child_methods</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@method_calls</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'><span class="c1">##############################   Methods   #####################################</span>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'><span class="k">def</span> <span class="nf">add_one_thread</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@all_threads</span><span class="o">[</span><span class="n">fields</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_i</span><span class="o">]=</span><span class="n">fields</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">add_one_method</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@all_methods</span><span class="o">[</span><span class="n">fields</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">]=</span><span class="n">fields</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">add_one_record</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
</span><span class='line'>    <span class="n">record</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;SLQ&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">record</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="vi">@target_thread</span>
</span><span class='line'>        <span class="n">method_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">record</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
</span><span class='line'>        <span class="n">method_action</span> <span class="o">=</span> <span class="n">record</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">%</span> <span class="mi">4</span>
</span><span class='line'>        <span class="vi">@all_records</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="o">[</span><span class="n">record</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">method_id</span><span class="p">,</span> <span class="n">method_action</span><span class="p">,</span> <span class="n">record</span><span class="o">[</span><span class="mi">2</span><span class="o">]]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">handle_one_call</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">,</span> <span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># p &quot;#{parent_method_id} -&gt; #{method_id}&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="vi">@parent_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@parent_methods</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span>  <span class="o">!</span><span class="vi">@child_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@child_methods</span><span class="o">[</span><span class="n">method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@method_calls</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">].</span><span class="n">has_key?</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>            <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">][</span><span class="n">method_id</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">][</span><span class="n">method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>        <span class="vi">@method_calls</span><span class="o">[</span><span class="n">parent_method_id</span><span class="o">][</span><span class="n">method_id</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gen_funcname</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cla_med</span> <span class="o">=</span> <span class="vi">@all_methods</span><span class="o">[</span><span class="n">method_id</span><span class="o">][</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[\/\$&lt;&gt;]/</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sub_med</span> <span class="o">=</span> <span class="vi">@all_methods</span><span class="o">[</span><span class="n">method_id</span><span class="o">][</span><span class="mi">2</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[\/\$&lt;&gt;]/</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">cla_med</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">sub_med</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gen_dot_script_file</span>
</span><span class='line'>    <span class="n">ofile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;graph.dot&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;digraph vanzo {</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@all_methods</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@parent_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span class='line'>            <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">  [shape=rectangle];</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="k">if</span> <span class="vi">@child_methods</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span class='line'>                <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">  [shape=ellipse];</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@method_calls</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@method_calls</span><span class="o">[</span><span class="nb">p</span><span class="o">].</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class='line'>          <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">#{</span><span class="n">gen_funcname</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2"> [label=&#39;</span><span class="si">#{</span><span class="vi">@method_calls</span><span class="o">[</span><span class="nb">p</span><span class="o">][</span><span class="n">c</span><span class="o">].</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&#39; fontsize=&#39;10&#39;];</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ofile</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'><span class="c1">########################## Script starts from here #############################</span>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;No input file specified.&quot;</span>
</span><span class='line'>    <span class="nb">exit</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">p</span> <span class="s2">&quot;input file not exists&quot;</span>
</span><span class='line'>    <span class="nb">exit</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Now handle the text part</span>
</span><span class='line'><span class="n">current_section</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">lines</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="n">lines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="n">line</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*version&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">current_section</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*threads&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">current_section</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>        <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*methods&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">current_section</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">line</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;*end&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">current_section</span> <span class="o">=</span> <span class="mi">4</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="mi">2</span>
</span><span class='line'>        <span class="n">add_one_thread</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="mi">3</span>
</span><span class='line'>        <span class="n">add_one_method</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Now handle the binary part</span>
</span><span class='line'><span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">alldata</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'><span class="c1">#alldata = File.read(ARGV[0])</span>
</span><span class='line'><span class="n">pos</span> <span class="o">=</span> <span class="n">alldata</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;SLOW&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="n">alldata</span><span class="o">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="n">pos</span> <span class="o">+=</span> <span class="n">offset</span> <span class="c1">#where the record begin</span>
</span><span class='line'><span class="n">record_num</span> <span class="o">=</span> <span class="n">alldata</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">pos</span>
</span><span class='line'><span class="n">record_num</span> <span class="o">/=</span> <span class="mi">14</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">record_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="n">add_one_record</span><span class="p">(</span><span class="n">alldata</span><span class="o">[</span><span class="n">pos</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_stack</span> <span class="o">=</span> <span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@all_records</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">onerecord</span><span class="o">|</span>
</span><span class='line'>  <span class="n">thread_id</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="n">method_id</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="n">action</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="n">time</span> <span class="o">=</span> <span class="n">onerecord</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">my_stack</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span class='line'>            <span class="n">parent_method_id</span> <span class="o">=</span> <span class="n">my_stack</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>            <span class="n">handle_one_call</span><span class="p">(</span><span class="n">parent_method_id</span><span class="p">,</span> <span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">my_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">method_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">my_stack</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span class='line'>                <span class="n">my_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">gen_dot_script_file</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;dot -Tjpg graph.dot -o output.png;rm -f graph.dot&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>用法：</p>

<pre><code>$ ruby dmtracedump.rb calc.trace
</code></pre>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/30/xi-tong-diao-yong-xue-xi-bi-ji-%28%5B%3F%5D-%29-linuxxi-tong-diao-yong-biao-%28zhuan-%29/">系统调用学习笔记（一） - Linux系统调用表（转）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/30/xi-tong-diao-yong-xue-xi-bi-ji-ptrace/">系统调用学习笔记 - ptrace和wait</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/14/tong-bu-yuan-yu-xue-xi-bi-ji-lock%2Crcuhe-transaction/">同步原语学习笔记 - Lock，RCU和Transaction Memory</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/09/netfilterxue-xi-bi-ji-%28san-%29/">Netfilter学习笔记（三）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/29/netfilterxue-xi-bi-ji-%28er-%29/">Netfilter学习笔记（二）</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("microtrain016", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/microtrain016" class="twitter-follow-button" data-show-count="false">Follow @microtrain016</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/mctrain016@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Liu Yutao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
